name: Ops Canary Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      rollout_percent:
        description: "Initial rollout percentage (10-100)"
        required: false
        default: "10"

jobs:
  canary:
    name: Canary Deploy with Auto-Rollout
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --frozen-lockfile

      - name: Run tests
        run: npm test --if-present

      - name: Build all workspaces
        run: npm run build --workspaces --if-present

      - name: Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcp-key.json
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > $GOOGLE_APPLICATION_CREDENTIALS
          firebase --version

      - name: Deploy Cloud Functions (Canary)
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcp-key.json
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          firebase deploy --only functions --project $FIREBASE_PROJECT_ID

      - name: Set Initial Canary Rollout
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcp-key.json
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          ROLLOUT_PERCENT: ${{ github.event.inputs.rollout_percent || '10' }}
        run: |
          node scripts/set-canary.js $ROLLOUT_PERCENT

      - name: Wait for Initial Health Check
        run: sleep 30

      - name: Verify Deployment Health
        run: |
          HEALTH_URL="https://readyz-vpxyxgcfbq-uc.a.run.app"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)

          if [ $RESPONSE -eq 200 ]; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed with status: $RESPONSE"
            exit 1
          fi

      - name: Create Deployment Record
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcp-key.json
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          node scripts/create-deployment-record.js

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "üöÄ Canary deployment successful!"
          echo "Initial rollout: ${{ github.event.inputs.rollout_percent || '10' }}%"
          echo "CanaryManager will progressively promote if SLOs hold"
          echo "Monitor at: https://dashboard.fz-labs.io/ops"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "‚ùå Canary deployment failed!"
          echo "Check logs and fix issues before retrying"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ${{ github.workspace }}/gcp-key.json
