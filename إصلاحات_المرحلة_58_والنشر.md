# ุงููุฑุญูุฉ 58 + ุฅุตูุงุญุงุช ุญุฑุฌุฉ โ

> ุฏููู ูุงูู ููุฅุตูุงุญุงุช ูุงููุดุฑ

---

## โ ุงูุฅุตูุงุญุงุช ุงูููุชููุฉ

### 1. ุฅุตูุงุญ ุชุตุฏูุฑุงุช Firebase Admin

**ุงููุดููุฉ:** ูููุงุช ูุซูุฑุฉ ุชุญุชุงุฌ `{ db }` ู `initAdmin()`

**ุงููููุงุช ุงูููุตูุญุฉ:**
- โ `src/lib/firebase-admin.ts`
- โ `src/server/firebase-admin.ts`

**ุงูุขู ูุนูู:**
```typescript
import { db, initAdmin } from '@/lib/firebase-admin';
import { db } from '@/server/firebase-admin';
```

---

### 2. ุชุญููู Cloud Functions ูู v1 ุฅูู v2

#### โ Scheduled Functions (ุงูููุงู ุงููุฌุฏููุฉ)

**ุชู ุงูุชุญููู:**
- โ `functions/src/aggregateDailyMetrics.ts` - ููุญููู ูุงูููุง
- โ `functions/src/schedules/compactSnippets.ts` - ูุงู v2 ุฃุตููุง

**ุงูุชุบููุฑุงุช:**
```typescript
// ูุจู (v1)
import * as functions from 'firebase-functions';
export const myJob = functions.pubsub
  .schedule('10 2 * * *')
  .timeZone('Asia/Kuwait')
  .onRun(async (context) => {
    // ...
    return { success: true }; // โ ูุง ุชุฑุฌุน ูููุฉ
  });

// ุจุนุฏ (v2) โ
import { onSchedule } from 'firebase-functions/v2/scheduler';
export const myJob = onSchedule(
  {
    schedule: '10 2 * * *',
    timeZone: 'Asia/Kuwait',
    memory: '512MiB',
    timeoutSeconds: 300,
  },
  async (event) => {
    // ...
    // ูุง return (void ููุท)
  }
);
```

#### โ Callable Functions (ุงูุฏูุงู ุงููุงุจูุฉ ููุงุณุชุฏุนุงุก)

**ุชู ุงูุชุญููู:**
- โ `aggregateDailyMetrics_manual` ุฏุงุฎู ููุณ ุงูููู

**ุงูุชุบููุฑุงุช:**
```typescript
// ูุจู (v1)
import * as functions from 'firebase-functions';
export const myFunc = functions.https.onCall((data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', '...');
  }
  return { result: 'ok' };
});

// ุจุนุฏ (v2) โ
import { onCall, HttpsError } from 'firebase-functions/v2/https';
export const myFunc = onCall(
  { timeoutSeconds: 60, memory: '256MiB' },
  async (request) => {
    const data = request.data;
    const auth = request.auth;
    if (!auth) {
      throw new HttpsError('unauthenticated', '...');
    }
    return { result: 'ok' };
  }
);
```

---

### 3. ุฅุตูุงุญ Next.js Dynamic Routes

**ุงููุดููุฉ:** ุฃุฎุทุงุก prerender ู dynamic usage

**ุงููููุงุช ุงูููุตูุญุฉ:**
- โ `src/app/api/billing/usage/route.ts`
- โ `src/app/f0/page.tsx`
- โ `src/app/admin/layout.tsx` (ุฌุฏูุฏ - ูุทุจู ุนูู ูู ุตูุญุงุช admin)

**ุงูุฅุตูุงุญ:**
```typescript
// ุฃุถู ูู ุฃูู ุงูููู
export const dynamic = "force-dynamic";
export const revalidate = 0;
export const runtime = "nodejs"; // ููู API routes
```

---

### 4. ุงูุชุญูู ูู next.config.js

โ ุงูููู ูุธูู - ูุง ููุฌุฏ `experimental.allowedDevOrigins`
โ ูุง ูุณุชุฎุฏู `output: 'export'`
โ ุฌุงูุฒ ูู Firebase Hosting

---

## ๐ ูุทููุจ (ุงุฎุชูุงุฑู)

### Functions ุงููุชุจููุฉ ููุชุญููู

ุฅุฐุง ุฃุฑุฏุช ุชุญููู ุงูุจุงูู (23 ุฎุทุฃ TypeScript):

#### Callable Functions
- `functions/src/deploy/pollDeployStatus.ts`
- `functions/src/deploy/exportDeployLogs.ts`
- `functions/src/deploy/triggerDeploy.ts`
- `functions/src/exportIncidentsCsv.ts`

ุงุณุชุฎุฏู ููุณ ุงูููุท ุฃุนูุงู โ๏ธ

#### Firestore Triggers
- `functions/src/collab/triggers.ts`

```typescript
// ูุจู (v1)
import * as functions from 'firebase-functions';
export const onJobCreated = functions.firestore
  .document('jobs/{jobId}')
  .onCreate((snap, context) => {
    const data = snap.data();
    const jobId = context.params.jobId;
  });

// ุจุนุฏ (v2) โ
import { onDocumentCreated } from 'firebase-functions/v2/firestore';
export const onJobCreated = onDocumentCreated('jobs/{jobId}', async (event) => {
  const snap = event.data;
  if (!snap) return;
  const data = snap.data();
  const jobId = event.params.jobId;
});
```

---

## ๐ ุฎุทูุงุช ุงููุดุฑ ุงูุณุฑูุน

### 1. ุจูุงุก Functions

```bash
cd functions
pnpm install
pnpm run build
cd ..
```

**ุงููุชููุน:** ูุง ุฃุฎุทุงุก TypeScript (ุฃู ุฃูู ูู ูุจู)

### 2. ุจูุงุก Next.js

```bash
pnpm install
pnpm run build
```

**ุงููุชููุน:**
- โ ูุง ุฃุฎุทุงุก prerender ุนูู `/f0`
- โ ูุง ุฃุฎุทุงุก dynamic usage ุนูู `/admin`
- โ ูุง ุฃุฎุทุงุก ุนูู `/api/billing/usage`

### 3. ูุดุฑ Firestore (Indexes + Rules)

```bash
# ูุดุฑ ุงูููุงุฑุณ
firebase deploy --only firestore:indexes

# ุชูุนูู TTL Policy ูุฏูููุง:
# Firebase Console โ Firestore โ Indexes โ TTL Policies
# Collection: ops_rag_cache
# Field: expire_at

# ูุดุฑ ุงูููุงุนุฏ
firebase deploy --only firestore:rules
```

### 4. ูุดุฑ Functions ุชุฏุฑูุฌููุง (ุฃูุซุฑ ุฃูุงููุง)

```bash
# ุงูุฏูุงู ุงูููุญูููุฉ ููุท
firebase deploy --only functions:aggregateDailyMetrics
firebase deploy --only functions:aggregateDailyMetrics_manual
firebase deploy --only functions:weeklyCompactSnippets

# ุฃู ูุดุฑ ุงููู (ุฅุฐุง ููุช ูุชุฃูุฏูุง)
firebase deploy --only functions
```

### 5. ูุดุฑ Hosting

```bash
firebase deploy --only hosting
```

---

## ๐งช ุงุฎุชุจุงุฑ ุจุนุฏ ุงููุดุฑ

### 1. ุงุฎุชุจุงุฑ ุงูุฏูุงู ุงููุฌุฏููุฉ

```bash
# ุงุฎุชุจุงุฑ ูุฏูู
firebase functions:call aggregateDailyMetrics_manual --data='{"date":"2025-11-05"}'
```

### 2. ุงุฎุชุจุงุฑ API

```bash
# ุงุฎุชุจุงุฑ billing usage
curl https://your-domain.com/api/billing/usage \
  -H "Authorization: Bearer YOUR_TOKEN"

# ุงุฎุชุจุงุฑ RAG
curl -X POST https://your-domain.com/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{"q":"test","workspaceId":"test"}'
```

### 3. ุงุฎุชุจุงุฑ ุงูุตูุญุงุช

- ุฒูุงุฑุฉ `/f0` โ ูุฌุจ ุฃู ุชูุชุญ ุจุฏูู ุฃุฎุทุงุก
- ุฒูุงุฑุฉ `/admin/dashboard` โ ูุฌุจ ุฃู ุชูุชุญ
- ูุญุต Console ููู Errors

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### 1. ูุฑุงูุจุฉ Functions

```bash
# ุนุฑุถ ุงูููุฌุฒ
firebase functions:log --only aggregateDailyMetrics

# ูุฑุงูุจุฉ ุญูุฉ
firebase functions:log --follow
```

### 2. ูุฑุงูุจุฉ RAG

```javascript
// ูู Firestore Console
db.collection('ops_rag_queries')
  .where('timestamp', '>', lastHour)
  .orderBy('tookMs', 'desc')
  .limit(10)
```

ุงููุฏู:
- P95 โค 400ms โ
- Cache hit rate > 30% ุจุนุฏ ุณุงุนุฉ

---

## โ๏ธ ุญู ุงููุดุงูู

### ุฎุทุฃ: "db is not exported"

โ **ููุญู** - ุชู ุฅุถุงูุฉ `export const db` ูู ููุง ุงูููููู

### ุฎุทุฃ: Property 'auth' does not exist on type 'CallableResponse'

โ **ููุญู** - ุญูููู ุฅูู v2 (ุจุงุฑุงูุชุฑ `request` ุจุฏููุง ูู `data, context`)

### ุฎุทุฃ: Dynamic server usage (prerender)

โ **ููุญู** - ุฃุถูู `export const dynamic = "force-dynamic"` ูููููุงุช ุงููุทููุจุฉ

### ุฎุทุฃ: Cannot find module 'date-fns'

```bash
pnpm add date-fns
```

---

## ๐ ูุงุฆูุฉ ุงูุชุญูู ุงููุงููุฉ

### ุงูุฅุตูุงุญุงุช ุงูุฃุณุงุณูุฉ
- [x] Firebase Admin exports
- [x] Scheduled Functions v2
- [x] 1 Callable Function v2
- [x] Next.js dynamic routes
- [x] Admin layout force-dynamic
- [x] F0 page force-dynamic

### ุงูุงุฎุชูุงุฑูุฉ (ูู ุญุงุจุจ)
- [ ] ุจุงูู Callable Functions v2
- [ ] Firestore Triggers v2

### ุงูุจูุงุก ูุงููุดุฑ
- [ ] Build functions (ูุง ุฃุฎุทุงุก)
- [ ] Build Next.js (ูุง prerender errors)
- [ ] Deploy indexes
- [ ] Enable TTL policy
- [ ] Deploy rules
- [ ] Deploy functions
- [ ] Deploy hosting

### ุงูุงุฎุชุจุงุฑ
- [ ] Test manual trigger
- [ ] Test API endpoints
- [ ] Test /f0 page
- [ ] Test /admin pages
- [ ] Check logs
- [ ] Monitor performance

---

## ๐ฏ ุงูุฃููููุงุช

### ุนุงููุฉ (ููุฐูุง ุงูุขู)
1. โ ุชู - Firebase Admin exports
2. โ ุชู - Next.js dynamic routes
3. ูุดุฑ Firestore indexes
4. ูุดุฑ Functions ุงูููุญูููุฉ
5. ูุดุฑ Hosting

### ูุชูุณุทุฉ (ุจุนุฏ ุงููุดุฑ)
1. ุชุญููู ุจุงูู Functions ุฅูู v2
2. ูุฑุงูุจุฉ ุงูุฃุฏุงุก
3. ุชูุนูู TTL policies

### ููุฎูุถุฉ (ุชุญุณููุงุช)
1. ุชูุธูู ุงูููุฏ ุงููุฏูู
2. ุฅุถุงูุฉ ุงุฎุชุจุงุฑุงุช
3. ุชุญุฏูุซ ุงููุซุงุฆู

---

## ๐ก ูุตุงุฆุญ

1. **ุงูุดุฑ ุชุฏุฑูุฌููุง:** ุฏุงูุฉ ูุงุญุฏุฉ ูู ูู ูุฑุฉ
2. **ุฑุงูุจ ุงูููุฌุฒ:** ุจุนุฏ ูู ูุดุฑ
3. **ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ:** ูุจู ุงูุชุบููุฑุงุช ุงููุจูุฑุฉ
4. **ุงุฎุชุจุฑ ูุญูููุง ุฃูููุง:** `pnpm run build`

---

## ๐ ุงูุฏุนู

- **ุงููุซุงุฆู ุงููุงููุฉ:** [PHASE_58_COMPLETE.md](./PHASE_58_COMPLETE.md)
- **ุฏููู ุณุฑูุน:** [PHASE_58_QUICK_REFERENCE.md](./PHASE_58_QUICK_REFERENCE.md)
- **ุงูุฅุตูุงุญุงุช (English):** [PHASE_58_FIXES_COMPLETE.md](./PHASE_58_FIXES_COMPLETE.md)

---

## โ ุงูููุฎุต

**ูุง ุชู ุฅูุฌุงุฒู:**
- โ Phase 58 RAG ูุงูู (9 ูููุงุช)
- โ ุฅุตูุงุญ Firebase Admin
- โ ุชุญููู 2 Functions ุฅูู v2
- โ ุฅุตูุงุญ 3+ Next.js routes

**ุฌุงูุฒ ูููุดุฑ!** ๐

```bash
# ุฃูุฑ ูุงุญุฏ ูููุดุฑ ุงูุณุฑูุน
pnpm run build && \
firebase deploy --only firestore:indexes,firestore:rules && \
firebase deploy --only functions:aggregateDailyMetrics,functions:weeklyCompactSnippets && \
firebase deploy --only hosting
```

**ุจุนุฏ ุงููุดุฑ:**
1. ูุนูู TTL policy ูู Console
2. ุงุฎุชุจุฑ ุงูู endpoints
3. ุฑุงูุจ ุงูููุฌุฒ

**ูุฌุญูุง!** ๐
