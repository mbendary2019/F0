rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================
    // Helper functions
    // ============================
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // نتأكد إن في claim اسمها admin قبل ما نلمسها
    function isAdmin() {
      return isSignedIn()
        && ('admin' in request.auth.token)
        && request.auth.token.admin == true;
    }

    function hasRole(role) {
      return isSignedIn()
        && ('role' in request.auth.token)
        && request.auth.token.role == role;
    }

    // ============================
    // Default: Deny everything
    // ============================
    match /{document=**} {
      allow read, write: if false;
    }

    // ============================================================
    // PHASE 85 — Dashboard Collections
    // ============================================================

    // -------- projects --------
    match /projects/{projectId} {
      // Helper function to check if user is project owner
      function isProjectOwner() {
        return isSignedIn() &&
               resource != null &&
               resource.data.ownerUid == request.auth.uid;
      }

      // قراءة: أي مستخدم مسجل (needed for subcollection rules that use get())
      // سنتحقق من الـ ownership في الـ subcollections نفسها
      allow read: if isSignedIn();

      // كتابة: صاحب المشروع فقط (with null check)
      allow write: if isSignedIn() &&
                     request.resource != null &&
                     request.resource.data.ownerUid == request.auth.uid;

      // -------- Phase 103: F0 Project Phases --------
      match /phases/{phaseId} {
        // قراءة: أي مستخدم مسجل (للنسخة التجريبية)
        allow read: if isSignedIn();

        // كتابة: Server only (Admin SDK)
        allow write: if false;
      }

      // -------- Phase 103: F0 Project Tasks --------
      match /tasks/{taskId} {
        // قراءة: أي مستخدم مسجل
        allow read: if isSignedIn();

        // كتابة: أي مستخدم مسجل (للنسخة التجريبية - سنحسن الأمان لاحقاً)
        allow update: if isSignedIn();

        // إنشاء: Server only (Admin SDK)
        allow create, delete: if false;
      }

      // -------- Phase 103: F0 Queued Actions --------
      match /queued_actions/{actionId} {
        // قراءة: أي مستخدم مسجل (للنسخة التجريبية)
        allow read: if isSignedIn();

        // كتابة: Server only (Admin SDK)
        allow write: if false;
      }

      // -------- Phase 104.2: Agent Messages --------
      match /agent_messages/{messageId} {
        // قراءة: أي مستخدم مسجل (للنسخة التجريبية - سنحسن الأمان لاحقاً)
        allow read: if isSignedIn();

        // كتابة: أي مستخدم مسجل (can add messages)
        allow create: if isSignedIn() &&
                        request.resource != null &&
                        request.resource.data.role in ['user', 'assistant', 'system'];

        // تعديل وحذف: ممنوع
        allow update, delete: if false;
      }

      // -------- ideSessions (IDE Bridge) --------
      match /ideSessions/{sessionId} {
        // قراءة: أي مستخدم مسجل
        allow read: if isSignedIn();

        // كتابة: أي مستخدم مسجل
        allow write: if isSignedIn();

        // events subcollection (IDE → Cloud)
        match /events/{eventId} {
          // قراءة: أي مستخدم مسجل
          allow read: if isSignedIn();

          // إنشاء: مسموح (IDE يبعت events)
          allow create: if true;

          // تعديل وحذف: ممنوع
          allow update, delete: if false;
        }

        // commands subcollection (Cloud → IDE)
        match /commands/{commandId} {
          // قراءة: مسموح (IDE يعمل poll)
          allow read: if true;

          // إنشاء: أي مستخدم مسجل
          allow create: if isSignedIn();

          // تعديل: مسموح (IDE يحدّث status)
          allow update: if true;

          // حذف: ممنوع
          allow delete: if false;
        }

        // patches subcollection
        match /patches/{patchId} {
          // قراءة: أي مستخدم مسجل
          allow read: if isSignedIn();

          // كتابة: أي مستخدم مسجل
          allow write: if isSignedIn();
        }
      }

      // NOTE: Phase 90.2 rules removed - using Phase 103 rules above instead

      // -------- media_assets (Phase 100: AI Media Studio) --------
      match /media_assets/{assetId} {
        // قراءة: مسموح للجميع (للنسخة التجريبية)
        allow read: if true;

        // إنشاء: مسموح للجميع (الـ API يحفظ الصور)
        allow create: if true;

        // تعديل وحذف: ممنوع من الـ client
        allow update, delete: if false;
      }

      // -------- Phase 138.0: Optimization Runs --------
      match /optimizationRuns/{runId} {
        // قراءة: أي مستخدم مسجل (same as parent project)
        // Note: Using isSignedIn() to match parent project read rule
        // The parent project already allows read for signed-in users
        allow read: if isSignedIn();

        // كتابة: Cloud Functions فقط (Admin SDK)
        allow create, update, delete: if false;
      }
    }

    // -------- deployments --------
    match /deployments/{deployId} {
      // قراءة: أي مستخدم مسجل
      allow read: if isSignedIn();

      // كتابة: أي مستخدم مسجل
      allow write: if isSignedIn();
    }

    // -------- wallets --------
    match /wallets/{uid} {
      // قراءة: صاحب الـ wallet فقط
      allow read: if isSignedIn() && request.auth.uid == uid;

      // كتابة: صاحب الـ wallet فقط
      allow write: if isSignedIn() && request.auth.uid == uid;
    }

    // -------- liveSessions --------
    match /liveSessions/{sessionId} {
      // قراءة: أي مستخدم مسجل
      allow read: if isSignedIn();

      // إنشاء: أي مستخدم مسجل (لازم ownerUid = request.auth.uid)
      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid;

      // تعديل: صاحب الـ session فقط
      allow update: if isSignedIn()
        && resource.data.ownerUid == request.auth.uid;

      // حذف: ممنوع من الـ client
      allow delete: if false;

      // events subcollection
      match /events/{eventId} {
        // قراءة: أي مستخدم مسجل
        allow read: if isSignedIn();

        // إنشاء: أي مستخدم مسجل (لازم ownerUid = request.auth.uid)
        allow create: if isSignedIn()
          && request.resource.data.ownerUid == request.auth.uid;

        // تعديل وحذف: ممنوع
        allow update, delete: if false;
      }
    }

    // ============================================================
    // PHASE 98.1: MARKETPLACE (Public read)
    // ============================================================

    // -------- ops_marketplace_apps (Public catalog) --------
    match /ops_marketplace_apps/{appSlug} {
      // قراءة: مسموح للجميع (صفحة عامة)
      allow read: if true;

      // كتابة: Admin SDK فقط (Cloud Functions)
      allow write: if false;
    }

    // ============================================================
    // LEGACY: PHASE 36/37 — F0 Ops Collections (Kept for backward compatibility)
    // ============================================================

    // -------- ops_projects --------
    match /ops_projects/{projectId} {

      // Helper محلي
      function isProjectOwner() {
        return isSignedIn() && resource.data.ownerUid == request.auth.uid;
      }

      // قراءة المشروع:
      // - صاحب المشروع
      // - أي admin
      allow get, list: if isProjectOwner() || isAdmin();

      // إنشاء مشروع:
      // - أي مستخدم مسجّل
      // - لازم يكتب ownerUid = request.auth.uid
      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid;

      // تعديل مشروع:
      // - صاحب المشروع
      // - admin
      allow update: if isProjectOwner() || isAdmin();

      // حذف مشروع:
      // - admin فقط
      allow delete: if isAdmin();

      // Phase 98: agent_messages subcollection
      match /agent_messages/{messageId} {
        // قراءة: مسموح للجميع (الـ UI يحتاجها - بما في ذلك anonymous)
        allow read: if true;

        // إنشاء: مسموح للجميع (الـ API يحفظ الرسائل)
        allow create: if true;

        // تعديل وحذف: ممنوع (للحفاظ على التاريخ)
        allow update, delete: if false;
      }

      // Phase 99: agent_sessions subcollection
      // Sessions link agent conversations to specific projects
      match /agent_sessions/{sessionId} {
        // قراءة: مسموح للجميع (للنسخة التجريبية)
        allow read: if true;

        // إنشاء: مسموح للجميع (الـ API يحفظ الجلسات)
        allow create: if true;

        // تعديل وحذف: ممنوع من الـ client
        allow update, delete: if false;
      }
    }

    // -------- ops_deployments --------
    match /ops_deployments/{deployId} {

      // نتأكد إن الحقول موجودة قبل ما نلمسها
      function hasDeploymentOwner() {
        return resource.data.keys().hasAll(['ownerUid']);
      }

      function isDeploymentOwner() {
        return isSignedIn()
          && hasDeploymentOwner()
          && resource.data.ownerUid == request.auth.uid;
      }

      // ✅ مؤقّتًا: أي مستخدم مسجّل يقدر يعمل list
      allow list: if isSignedIn();

      // ✅ قراءة دكمنت واحدة: صاحبها أو admin
      allow get: if isDeploymentOwner() || isAdmin();

      // ❌ ممنوع أي كتابة من الـ client
      allow create, update, delete: if false;
    }

    // -------- ops_aiLogs --------
    match /ops_aiLogs/{logId} {

      function hasLogOwner() {
        return resource.data.keys().hasAll(['ownerUid']);
      }

      function isLogOwner() {
        return isSignedIn()
          && hasLogOwner()
          && resource.data.ownerUid == request.auth.uid;
      }

      // قراءة:
      // - صاحب الـ log
      // - admin
      allow get, list: if isLogOwner() || isAdmin();

      // إنشاء:
      // - أي مستخدم مسجّل
      // - ownerUid = request.auth.uid
      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid;

      // تعديل:
      // - نفس صاحب الـ log
      // - أو admin
      allow update: if isLogOwner() || isAdmin();

      // حذف:
      // - admin فقط
      allow delete: if isAdmin();
    }

    // -------- ops_activity --------
    match /ops_activity/{eventId} {

      function hasEventOwner() {
        return resource.data.keys().hasAll(['ownerUid']);
      }

      function isEventOwner() {
        return isSignedIn()
          && hasEventOwner()
          && resource.data.ownerUid == request.auth.uid;
      }

      // قراءة:
      // - صاحب الحدث
      // - admin
      allow get, list: if isEventOwner() || isAdmin();

      // كتابة من Functions فقط (مقفولة حاليًا)
      allow create, update, delete: if false;
    }

    // ============================================================
    // PHASE 36: AUDIT LOGS (Admin-only read, CF-only write)
    // ============================================================

    match /audits/{day} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only

      match /events/{eventId} {
        allow read: if isAdmin();
        allow write: if false; // Cloud Functions only
      }
    }

    match /audits_meta/{day} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    match /admin_activity/{eventId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // PHASE 170: LLM RUNS (Multi-Model Orchestrator Benchmarks)
    // ============================================================

    match /llmRuns/{runId} {
      // Helper function to check ownership
      function isRunOwner() {
        return isSignedIn()
          && resource.data.keys().hasAll(['userId'])
          && resource.data.userId == request.auth.uid;
      }

      // قراءة: صاحب الـ run أو admin
      allow read: if isRunOwner() || isAdmin();

      // كتابة: Cloud Functions فقط (Admin SDK)
      // Benchmark data is written server-side only
      allow create, update, delete: if false;
    }

    // ============================================================
    // USER DATA
    // ============================================================

    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow write: if isOwner(uid);

      // الأجهزة
      match /devices/{deviceId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if isOwner(uid);
      }

      // Offline queue
      match /queues/{deviceId} {
        allow read, write: if isOwner(uid);
      }

      // User balance/credits
      match /balances/{doc} {
        allow read: if isOwner(uid);
        allow write: if false; // Cloud Functions only
      }
    }
  }
}
