// F0 Phase 36 - Security Hardened Firestore Rules
// Combined rules for Phase 35 + 36

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function hasRole(role) {
      return isSignedIn() && request.auth.token.role == role;
    }

    // Default: Deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // ============================================================
    // PHASE 36: AUDIT LOGS (Admin-only read, CF-only write)
    // ============================================================

    match /audits/{day} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only

      match /events/{eventId} {
        allow read: if isAdmin();
        allow write: if false; // Cloud Functions only
      }
    }

    match /audits_meta/{day} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    match /admin_activity/{eventId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // USER DATA
    // ============================================================

    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow write: if isOwner(uid);

      // Phase 35: Device presence & capabilities
      match /devices/{deviceId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if isOwner(uid); // User can update their devices
      }

      // Phase 35: Offline queue
      match /queues/{deviceId} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
      }

      // User balance/credits
      match /balances/{doc} {
        allow read: if isOwner(uid);
        allow write: if false; // Cloud Functions only
      }

      // User's installed extensions
      match /extensions/{name} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
      }
    }

    // ============================================================
    // PROJECTS & COLLABORATION
    // ============================================================

    match /projects/{projectId} {
      // Read: ownerUid or team members
      allow read: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid ||
        (resource.data.keys().hasAny(['members']) && request.auth.uid in resource.data.members)
      );

      // Create: user can create project with their own ownerUid
      allow create: if isSignedIn() &&
        request.resource.data.ownerUid == request.auth.uid &&
        request.resource.data.keys().hasAll(['name', 'ownerUid']);

      // Update/Delete: ownerUid only
      allow update, delete: if isSignedIn() &&
        resource.data.ownerUid == request.auth.uid;

      // Project state (per-user)
      match /states/{uid} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
      }

      // Phase 74: Agent-Driven Development subcollections
      match /phases/{phaseId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }

      match /tasks/{taskId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }

      match /activity/{logId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }

      match /threads/{threadId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }

      // Phase 72: Domain Management
      match /domains/{domainId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }

    // ============================================================
    // PHASE 35: SESSIONS & JOBS
    // ============================================================

    match /sessions/{jobId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false; // Cloud Functions only
    }

    // ============================================================
    // PHASE 35: DEVICE HANDOFF
    // ============================================================

    match /handshake/{handoffId} {
      // Anyone can read (need short-lived link)
      allow read: if isSignedIn();

      // Only CF can write
      allow write: if false;
    }

    // ============================================================
    // ADMIN COLLECTIONS
    // ============================================================

    match /admins/{uid} {
      allow read: if isAdmin();
      allow write: if false; // Manual provisioning only
    }

    match /ops_policies/{policyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /rate_limits/{key} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // PHASE 53: REALTIME COLLABORATION
    // ============================================================

    // Collaboration rooms
    match /collab_rooms/{roomId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Sessions within a room
      match /sessions/{sessionId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if false; // Cloud Functions only
      }
    }

    // Collaboration events (audit log)
    match /collab_events/{eventId} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    // Chat messages (Day 4)
    match /ops_collab_messages/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Immutable messages
    }

    // AI Summaries (Day 5 - CF-only write)
    match /ops_collab_summaries/{id} {
      allow read: if isSignedIn();
      allow create, update, delete: if false; // Cloud Functions only
    }

    // Collaboration Sessions (Day 6 - Memory Timeline)
    match /ops_collab_sessions/{id} {
      allow read: if isSignedIn();
      allow create, update: if isAdmin(); // CF or Admin only
      allow delete: if false; // Immutable
    }

    // Collaboration Memory (Day 6 - Timeline)
    match /ops_collab_memory/{id} {
      allow read: if isSignedIn();

      // Users can create manual pins/notes
      allow create: if isSignedIn() &&
        request.resource.data.writer == 'user' &&
        request.resource.data.createdBy.uid == request.auth.uid;

      // Users can update their own pins (toggle pinned status)
      allow update: if isSignedIn() && (
        (resource.data.writer == 'user' &&
         resource.data.createdBy.uid == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pinned'])) ||
        isAdmin()
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // Collaboration Embeddings (Day 7 - Semantic Search)
    match /ops_collab_embeddings/{id} {
      // Users can read embeddings
      allow read: if isSignedIn();

      // Only Cloud Functions can write/update/delete
      // (Admin SDK bypasses rules automatically)
      allow create, update, delete: if false;
    }

    match /feature_flags/{flag} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ============================================================
    // EXTENSIONS & MARKETPLACE
    // ============================================================

    match /extensions_registry/{id} {
      allow read: if true; // Public registry
      allow write: if false; // Admin/CF only
    }

    // ============================================================
    // BILLING & LICENSING
    // ============================================================

    match /licenses/{key} {
      allow read: if isSignedIn();
      allow write: if false; // Cloud Functions only
    }

    match /billing/plans/{id} {
      allow read: if true; // Public pricing
      allow write: if false;
    }

    match /usage/{uid}/daily/{date} {
      allow read: if isOwner(uid) || isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // DEPLOY JOBS
    // ============================================================

    match /deploy_jobs/{jobId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // AI GOVERNANCE (from previous phases)
    // ============================================================

    match /ai_evals/{evalId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    match /hitl_queue/{itemId} {
      allow read: if isAdmin() || hasRole('reviewer');
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // METRICS & MONITORING
    // ============================================================

    match /api_metrics_daily/{date} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    match /alert_rules/{ruleId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /anomaly_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // RL POLICY & DECISIONS (Phase 33)
    // ============================================================

    match /rl_policy/{doc} {
      allow read: if isAdmin();
      allow write: if false; // Auto-tuning only
    }

    match /rl_decisions/{decisionId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    match /rl_outcomes/{outcomeId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // PHASE 36: LEARNING SYSTEM
    // ============================================================

    function isService() {
      return isSignedIn() && (
        request.auth.token.role == 'service' ||
        request.auth.token.role == 'admin'
      );
    }

    match /ops_observations/{id} {
      allow create: if isService();
      allow read: if isService() || isAdmin();
      allow update, delete: if false;
    }

    match /ops_rewards/{id} {
      allow create: if isService();
      allow read: if isService() || isAdmin();
      allow update, delete: if false;
    }

    match /ops_stats/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /ops_audit/{id} {
      allow create: if isService() || isAdmin();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    match /config/{doc} {
      allow read: if isService() || isAdmin();
      allow write: if isAdmin();
    }

    // ============================================================
    // PHASE 37: META-LEARNING & ADAPTIVE POLICIES
    // ============================================================

    match /ops_confidence/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /ops_decisions/{id} {
      allow create: if isService() || isAdmin();
      allow read: if isService() || isAdmin();
    }

    // ============================================================
    // PHASE 38: COGNITIVE KNOWLEDGE GRAPH
    // ============================================================

    match /ops_graph_nodes/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /ops_graph_edges/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    // ============================================================
    // PHASE 39: SELF-GOVERNANCE & ETHICAL AI
    // ============================================================

    match /ops_governance_policies/{id} {
      allow create, update: if isAdmin();
      allow read: if isService() || isAdmin();
    }

    match /ops_risk_scores/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /ops_governance_reports/{id} {
      allow write: if isService();
      allow read: if isAdmin();
    }

    // ============================================================
    // PHASE 40: AUTONOMOUS ECOSYSTEM
    // ============================================================

    match /ops_deploy_plans/{id} {
      allow create: if isService() || isAdmin();
      allow update: if isService() || isAdmin();
      allow read: if isService() || isAdmin();
    }

    match /ops_health_probes/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /ops_econ_objectives/{id} {
      allow write: if isService() || isAdmin();
      allow read: if isService() || isAdmin();
    }

    match /ops_bus_messages/{id} {
      allow create: if isService();
      allow read: if isService() || isAdmin();
    }

    // ============================================================
    // PHASE 41: COGNITIVE FEDERATION
    // ============================================================

    match /fed_peers/{id} {
      allow read, write: if isAdmin();
    }

    match /fed_inbox/{id} {
      allow create: if isService();
      allow read: if isService() || isAdmin();
    }

    match /fed_outbox/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /global_risk_ledger/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    // ============================================================
    // PHASE 42: FEDERATED CONSENSUS & COLLECTIVE OPTIMIZATION
    // ============================================================

    match /consensus_proposals/{id} {
      allow create: if isService();
      allow update: if isService(); // For vote updates
      allow read: if isService() || isAdmin();
    }

    match /consensus_votes/{id} {
      allow create: if isService();
      allow read: if isService() || isAdmin();
    }

    match /fed_economics/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /incentive_credits/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /trust_scores/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    // ============================================================
    // PHASE 43: GLOBAL COGNITIVE MESH
    // ============================================================

    match /mesh_peers/{id} {
      allow read, write: if isAdmin();
    }

    match /mesh_links/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    match /mesh_gossip/{id} {
      allow create: if isService();
      allow read: if isService() || isAdmin();
    }

    match /mesh_snapshots/{id} {
      allow write: if isService();
      allow read: if isService() || isAdmin();
    }

    // ============================================================
    // PHASE 44: ADD-ONS PACK (QUOTA + FIGMA + MARKETPLACE)
    // ============================================================

    // User quota plans: users can read their own, writes via CF only
    match /ops_user_plans/{uid} {
      allow read: if isOwner(uid);
      allow write: if false; // Cloud Functions only
    }

    // Branding settings: public read, admin write
    match /ops_branding/{env} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Marketplace items: public read, admin write
    match /ops_marketplace_items/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Design assets: public read, writes via CF only
    match /ops_assets/{assetId} {
      allow read: if true;
      allow write: if false; // Cloud Functions only
    }

    // Audit logs: admin read only, writes via CF only
    match /ops_audit/{id} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // PHASE 45: MONETIZATION & PREMIUM UPGRADES
    // ============================================================

    // Billing plans catalog: public read, admin write
    match /ops_billing_plans/{planId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Billing events: user can read own, CF writes only
    match /billing_events/{id} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow write: if false; // Cloud Functions only
    }

    // Billing invoices: user can read own, CF writes only
    match /billing_invoices/{invoiceId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow write: if false; // Cloud Functions only
    }

    // Paid marketplace items: enhanced rules
    match /ops_marketplace_paid/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Phase 45.2: Installation records
    match /ops_installs/{installId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow write: if false; // Cloud Functions only
    }

    // Phase 45.2: User plans - read own, CF writes only
    match /ops_user_plans/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow write: if false; // Cloud Functions only (via webhook/reconcile)
    }

    // Phase 46: Usage tracking - daily
    match /ops_usage_daily/{id} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow write: if false; // Cloud Functions only
    }

    // Phase 46: Usage tracking - monthly
    match /ops_usage_monthly/{id} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow write: if false; // Cloud Functions only
    }

    // Phase 46: Invoices
    match /ops_invoices/{id} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow write: if false; // Cloud Functions only (via Stripe webhook)
    }

    // Phase 47: Organizations
    match /ops_orgs/{orgId} {
      // Read: Any member can read org details
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/ops_org_members/$(orgId + '_' + request.auth.uid));
      // Write: Cloud Functions only
      allow write: if false;
    }

    // Phase 47: Organization Members
    match /ops_org_members/{memberId} {
      // Read: Any member can read all members in their org
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/ops_org_members/$(resource.data.orgId + '_' + request.auth.uid));
      // Write: Cloud Functions only
      allow write: if false;
    }

    // Phase 47: Organization Invites
    match /ops_org_invites/{inviteId} {
      // Read: Members can read invites for their org, or invitees can read their own invites
      allow read: if isSignedIn() && (
        exists(/databases/$(database)/documents/ops_org_members/$(resource.data.orgId + '_' + request.auth.uid)) ||
        resource.data.email == request.auth.token.email
      );
      // Write: Cloud Functions only
      allow write: if false;
    }

    // ============================================================
    // PHASE 48: ANALYTICS & AUDIT TRAIL
    // ============================================================

    // Analytics Events (raw data)
    match /ops_events/{id} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // Daily Metrics (aggregated)
    match /ops_metrics_daily/{id} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // Audit Trail (security-sensitive actions)
    match /ops_audit/{id} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    // ============================================================
    // PHASE 49: ERROR TRACKING & INCIDENT CENTER
    // ============================================================

    // Incidents: Admins can read/write for managing incidents
    match /ops_incidents/{id} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Incident updates/timeline: Immutable log
    match /ops_incident_updates/{id} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false; // immutable timeline
    }

    // Alerts queue (internal, functions only)
    match /_alerts_queue/{id} {
      allow read, write: if false; // Functions only
    }

    // ============================================================
    // PHASE 50: AI STUDIO (Assets & Jobs)
    // ============================================================

    // Studio Assets: Users can read/write their own assets
    match /studio_assets/{assetId} {
      // Users can read their own assets, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Users can create assets with their own userId
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['userId', 'fileName', 'fileType', 'fileSize', 'storagePath', 'storageUrl', 'createdAt', 'updatedAt']);

      // Users can update their own assets (for tags, metadata, etc.)
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;

      // Users can delete their own assets
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // Studio Jobs: Users can read/write their own jobs, Cloud Functions can update status
    match /studio_jobs/{jobId} {
      // Users can read their own jobs, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Users can create jobs with their own userId
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['userId', 'assetId', 'type', 'provider', 'status', 'parameters', 'createdAt', 'updatedAt']);

      // Cloud Functions can update job status (webhook updates)
      // Users cannot directly update jobs
      allow update: if false;

      // Users can delete their own jobs
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // Studio Scenes: Users can manage their own scenes
    match /studio_scenes/{sceneId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // PHASE 51: ONE-CLICK DEPLOY SYSTEM
    // ============================================================

    // Deploy Jobs: Users can read their own jobs, Cloud Functions can write
    match /ops_deploy_jobs/{jobId} {
      // Users can read their own deploy jobs, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Cloud Functions can create and update deploy jobs
      allow create, update: if false; // Cloud Functions only (via admin SDK)

      // Users can delete their own deploy jobs
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // PHASE 52: GITHUB INTEGRATION
    // ============================================================

    // GitHub Accounts: Users can only read/write their own account
    // docId = <uid>
    match /ops_github_accounts/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // GitHub Repos: Users can read/write their own repos
    // docId = <uid>__<repoId>
    match /ops_github_repos/{docId} {
      allow read, write: if isSignedIn()
        && request.auth.uid == resource.data.userId;
    }

    // GitHub Activity: Users can read their own activity
    match /ops_github_activity/{activityId} {
      // Users can read their own activity, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Cloud Functions only for writes (webhooks)
      allow create, update, delete: if false;
    }

    // ============================================================
    // PHASE 57: AI MEMORY SYSTEM (Snippet Cache & Feedback)
    // ============================================================

    // Phase 57.2: Snippet Cache - embeddings cache with deduplication
    match /ops_memory_snippets/{snipId} {
      // Admins can read all snippets for analytics
      allow read: if isAdmin();

      // Cloud Functions only for writes (automatic caching)
      allow create, update, delete: if false;
    }

    // Phase 57.2: Snippet Feedback - per-snippet quality signals
    match /ops_memory_snippet_feedback/{feedbackId} {
      // Users can read their own feedback, admins can read all
      allow read: if isSignedIn() && (
        resource.data.user_id == request.auth.uid ||
        isAdmin()
      );

      // Cloud Functions only for writes (via API endpoint)
      allow create, update, delete: if false;
    }

    // Phase 57.2: Snippet Metrics - daily performance metrics
    match /ops_metrics_snippets_daily/{day} {
      // Admins can read metrics for analytics dashboard
      allow read: if isAdmin();

      // Cloud Functions only for writes (automatic aggregation)
      allow create, update, delete: if false;
    }

    // ============================================================
    // PHASE 63: DAILY METRICS AGGREGATION
    // ============================================================

    // Daily metrics - aggregated ops_events data
    match /ops_metrics_daily/{docId} {
      // Authenticated users can read metrics for analytics dashboard
      allow read: if isSignedIn();

      // Only admins can write (via backfill callable)
      // Cloud Functions write automatically (scheduled aggregation)
      allow create, update: if isAdmin();
      allow delete: if false; // Never delete metrics
    }

    // ============================================================
    // PHASE 63 DAY 3: DAILY REPORTS
    // ============================================================

    // Daily reports - PDF and XLSX file metadata
    match /ops_reports/{date} {
      // Any authenticated user can read report metadata
      // (Actual files are in Cloud Storage with signed URLs)
      allow read: if isSignedIn();

      // Only admins can write (via Cloud Functions)
      allow create, update: if isAdmin();
      allow delete: if false; // Never delete reports
    }

    // Community analytics events (anonymous tracking)
    match /ops_community_events/{id} {
      // Internal tracking events, not readable from client
      allow read: if false;
      // Written only via API server (admin SDK)
      allow write: if request.time != null;
    }

    // ============================================================
    // PHASE 71: OPS PROJECTS & INTEGRATIONS
    // ============================================================

    // Ops Projects: Users can read/write their own projects
    match /ops_projects/{projectId} {
      // Any signed-in user can read/write (for development)
      // TODO: In production, restrict to project owner/members
      allow read, write: if isSignedIn();

      // Integrations subcollection
      match /integrations/{integrationId} {
        // Any signed-in user can read/write integrations
        allow read, write: if isSignedIn();
      }

      // PHASE 73: Environment Variables
      // Simple subcollection for env vars (read/write via Cloud Functions)
      match /envVars/{key} {
        // Any signed-in user can read/write env vars
        allow read, write: if isSignedIn();
      }
    }

    // DEPRECATED: Old direct env vars structure (kept for backward compatibility)
    match /ops_project_env/{projectId}/vars/{varId} {
      // Any signed-in user can read/write (for development)
      // TODO: In production, restrict to project owner/members
      allow read, write: if isSignedIn();
    }
  }
}


