# ุงููุฑุญูุฉ 60: ุชูุงูู ุงููููุงุก ุงููุชุนุฏุฏูู ูุน RAG - ููุชูู โ

## ูุธุฑุฉ ุนุงูุฉ

ุงููุฑุญูุฉ 60 ุชููุฐ ูุธุงู ุดุจูุฉ ูุนุฑููุฉ ูุชูุฏู (Cognitive Mesh) ูุน ูุฏุฑุงุช ุงุณุชุฑุฌุงุน ูุนุฒุฒุฉ ุจุงูุชูููุฏ (RAG). ูููู ุงููุธุงู ุจุชูุณูู ุนุฏุฉ ูููุงุก ุฐูุงุก ุงุตุทูุงุนู ูุชุฎุตุตูู ูุชุนุงูููู ููุจุญุซ ูุงูุชุฑููุจ ูุงูุชุญูู ูู ุงููุนูููุงุช ูู ูุฎุฒู ุงูุฐุงูุฑุฉ.

## ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### ุฃุฏูุงุฑ ุงููููุงุก

1. **ูููู ุงูุชุฎุทูุท** (`plannerAgent.ts`)
   - ููุณู ุงูุฃูุฏุงู ุงููุนูุฏุฉ ุฅูู ุฎุทุท ูุงุจูุฉ ููุชูููุฐ
   - ููุฌู ุงูููุงู ุฅูู ุงููููุงุก ุงููุชุฎุตุตูู ุงูููุงุณุจูู
   - ููุณู ุณูุฑ ุงูุนูู ุงูุนุงู

2. **ูููู ุงูุจุญุซ** (`researcherAgent.ts`)
   - ูุณุชุฑุฌุน ุงููุณุชูุฏุงุช ุฐุงุช ุงูุตูุฉ ูู ูุฎุฒู ุงูุฐุงูุฑุฉ
   - ูุฑุชุจ ุงููุชุงุฆุฌ ุญุณุจ ุงูุตูุฉ
   - ูุจูู ุงุณุชุดูุงุฏุงุช ุงูุฃุฏูุฉ

3. **ูููู ุงูุชุฑููุจ** (`synthesizerAgent.ts`)
   - ูุฏูุฌ ุงูุญูุงุฆู ูู ูุฑุถูุงุช ูุชูุงุณูุฉ
   - ููููู ุงููุนูููุงุช ุจุดูู ููุทูู
   - ูุญุถุฑ ุงูุฅุฌุงุจุงุช ููุชุญูู

4. **ูููู ุงูููุฏ** (`criticAgent.ts`)
   - ูุชุญูู ูู ุฏูุฉ ุงููุฑุถูุงุช
   - ููุญุต ุงูุชุญูุฒ ูุงููููุณุฉ
   - ูููุฑ ุญููุฉ ููุงุญุธุงุช ููุชุญุณูู

### ููููุงุช RAG

1. **ุงูููุณุชุฑุฌุน** (`rag/retriever.ts`)
   - ุจุญุซ ูุชุฌูู ุถุฏ `ops_memory_snippets`
   - ุชุตููุฉ ูุงุนูุฉ ุจุงูุณูุงู ุญุณุจ workspace/cluster
   - ุฅุฑุฌุงุน ูุณุชูุฏุงุช ุฎุงู ูุน embeddings

2. **ุงูููุฑุชุจ** (`rag/ranker.ts`)
   - ุชุณุฌูู ุงููุณุชูุฏุงุช ุญุณุจ ุงูุตูุฉ
   - ุชุทุจูู ูุทุงุจูุฉ ูููุงุช ููุชุงุญูุฉ (BM25-like)
   - ุชุฑุชูุจ ุงููุชุงุฆุฌ ุจุชุฑุชูุจ ุชูุงุฒูู

3. **ุงูููุซุฑู** (`rag/enrichers.ts`)
   - ุจูุงุก ุงุณุชุดูุงุฏุงุช ูู ุงููุณุชูุฏุงุช ุงููุฑุชุจุฉ
   - ุงุณุชุฎุฑุงุฌ ููุชุทูุงุช ูุจูุงูุงุช ูุตููุฉ
   - ุฅุซุฑุงุก ุงููุณุชูุฏุงุช ุจุนุฏุฏ ุงููููุงุช ูุงูุทูุงุจุน ุงูุฒูููุฉ

4. **ุงููููุณูู** (`rag/chunker.ts`)
   - ุชูุณูู ุงููุตูุต ุงูุทูููุฉ ุฅูู ุฃุฌุฒุงุก ูุงุจูุฉ ููุฅุฏุงุฑุฉ
   - ุญุฌู ุงูุฌุฒุก ูุงูุชุฏุงุฎู ูุงุจู ููุชูููู
   - ุงูุญูุงุธ ุนูู ุงูุญุฏูุฏ ุงูุฏูุงููุฉ

5. **ูุงูู ุงูุฐุงูุฑุฉ** (`rag/memoryBus.ts`)
   - pub/sub ูู ุงูุฐุงูุฑุฉ ูุชูุงุตู ุงููููุงุก
   - ุชุณุฌูู ูุชุตููุฉ ุงูุฑุณุงุฆู
   - ููุท Singleton ูุญุงูุฉ ุนูู ูุณุชูู ุงูุนูููุฉ

6. **ุงูุฅุฌูุงุน** (`rag/consensus.ts`)
   - ุงุณุชุฑุงุชูุฌูุชุงู: "majority" ู "critic"
   - ุงูุชุญูู ูู ุงูุงุชูุงู ุนุจุฑ ุงููููุงุก
   - ุนุฏ ุงูุฎูุงูุงุช ูุชูุฏูู ุงูุฃุณุจุงุจ

## ููุงุท ุงูููุงูุฉ API

### POST `/api/mesh/execute`

ุชูููุฐ ูููุฉ ุดุจูุฉ ูุนุฑููุฉ ุฌุฏูุฏุฉ.

**ุงูุทูุจ:**
```json
{
  "goal": "ุงุดุฑุญ ููู ูุนูู ุฎุท ุงูุฐุงูุฑุฉ ุงูุฒููู",
  "hints": ["ุฑูุฒ ุนูู React hooks"],
  "clusterIds": ["workspace-123"],
  "strategy": "critic"
}
```

**ุงูุฑุฏ:**
```json
{
  "sessionId": "mesh_1699...",
  "final": {
    "type": "FINAL",
    "content": "ุฎุท ุงูุฐุงูุฑุฉ ุงูุฒููู ูุณุชุฎุฏู useMemoryTimeline hook...",
    "evidence": [...]
  },
  "trace": [...],
  "consensus": {
    "accepted": true,
    "disagreements": 0
  },
  "metrics": {
    "totalMs": 1234,
    "tokensUsed": 850,
    "citationsCount": 3
  }
}
```

### POST `/api/mesh/continue`

ุงุณุชูุฑุงุฑ ุฌูุณุฉ ููุฌูุฏุฉ ูุน ููุงุญุธุงุช.

## SDK Client

```typescript
import { createMeshClient } from "@/sdk/meshClient";

const client = createMeshClient({
  baseUrl: "/api/mesh",
  apiKey: "ููุชุงุญ-api-ุงุฎุชูุงุฑู"
});

// ุชูููุฐ ูููุฉ ุฌุฏูุฏุฉ
const result = await client.execute({
  goal: "ููู ุฃููู ุจูุดุฑ ูุฐุง ุงููุดุฑูุนุ",
  strategy: "critic"
});

console.log(result.final.content);
console.log(`ุงูุงุณุชุดูุงุฏุงุช: ${result.final.evidence?.length}`);

// ุงููุชุงุจุนุฉ ูุน ููุงุญุธุงุช
const continued = await client.continue({
  sessionId: result.sessionId,
  feedback: "ูุงุฐุง ุนู ูุดุฑ ุงูุฅูุชุงุฌุ"
});
```

## ุงูุงุฎุชุจุงุฑ

ุชุดุบูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช:

```bash
pnpm test __tests__/retriever.spec.ts
pnpm test __tests__/ranker.spec.ts
pnpm test __tests__/enrichers.spec.ts
pnpm test __tests__/memoryBus.spec.ts
pnpm test __tests__/consensus.spec.ts
```

## ุงููููุงุช ุงููููุดุฃุฉ

### ุชุนุฑููุงุช ุงูุฃููุงุน
- โ `src/lib/types/context.ts`
- โ `src/lib/types/agent.ts`
- โ `src/lib/types/telemetry.ts`

### ุจููุฉ ุงูุดุจูุฉ
- โ `src/orchestrator/mesh/messageTypes.ts`
- โ `src/orchestrator/mesh/protocol.ts`
- โ `src/orchestrator/mesh/router.ts`

### ุฃุฏูุงุฑ ุงููููุงุก
- โ `src/orchestrator/agents/baseAgent.ts`
- โ `src/orchestrator/agents/roles/plannerAgent.ts`
- โ `src/orchestrator/agents/roles/researcherAgent.ts`
- โ `src/orchestrator/agents/roles/synthesizerAgent.ts`
- โ `src/orchestrator/agents/roles/criticAgent.ts`

### ููููุงุช RAG
- โ `src/orchestrator/rag/retriever.ts`
- โ `src/orchestrator/rag/ranker.ts`
- โ `src/orchestrator/rag/enrichers.ts`
- โ `src/orchestrator/rag/chunker.ts`
- โ `src/orchestrator/rag/memoryBus.ts`
- โ `src/orchestrator/rag/consensus.ts`

### SDK & API
- โ `src/sdk/meshClient.ts`
- โ `src/app/api/mesh/execute/route.ts`
- โ `src/app/api/mesh/continue/route.ts`

### ุงูุงุฎุชุจุงุฑุงุช
- โ `__tests__/retriever.spec.ts`
- โ `__tests__/ranker.spec.ts`
- โ `__tests__/enrichers.spec.ts`
- โ `__tests__/memoryBus.spec.ts`
- โ `__tests__/consensus.spec.ts`

## ูุฌููุนุงุช Firestore

### `ops_mesh_sessions`

ูุฎุฒู ุฌูุณุงุช ุชูููุฐ ุงูุดุจูุฉ.

**ุงููุฎุทุท:**
```typescript
{
  userId: string;
  goal: string;
  hints?: string[];
  clusterIds?: string[];
  strategy: "majority" | "critic";
  startedAt: Timestamp;
  completedAt?: Timestamp;
  continuedAt?: Timestamp;
  lastFeedback?: string;
  trace: AgentMessage[];
  final: AgentMessage;
  consensus: {
    accepted: boolean;
    disagreements?: number;
  };
  metrics: {
    totalMs: number;
    tokensUsed: number;
    citationsCount: number;
  };
}
```

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ุชุญุณููุงุช ุงูุฅูุชุงุฌ

1. **ุชุทุจูู ุงูุจุญุซ ุงููุชุฌูู**
   - ุงุณุชุจุฏุงู ุงูููุณุชุฑุฌุน ุงููุคูุช ุจู Vertex AI Vector Search
   - ุฅุถุงูุฉ ุชูููุฏ embeddings ูููุณุชูุฏุงุช
   - ุชุทุจูู ุชุฑุชูุจ ุงูุชุดุงุจู ุงูุฏูุงูู

2. **ุฅุฌูุงุน ูุชูุฏู**
   - ุชุทุจูู ูุดู ุงูุงุชูุงู ุงูุฏูุงูู ุงูููุงุณุจ
   - ุฅุถุงูุฉ ุชุณุฌูู ุงูุซูุฉ
   - ุฏุนู ุงูุชุตููุช ุงูููุฒูู

3. **Streaming API**
   - ุชุทุจูู Server-Sent Events (SSE)
   - ุจุซ ุฑุณุงุฆู ุงููููุงุก ูู ุงูููุช ุงููุนูู
   - ุฅุถุงูุฉ ูุคุดุฑุงุช ุงูุชูุฏู

4. **ุทุจูุฉ ุงูุชุฎุฒูู ุงููุคูุช**
   - ุชุฎุฒูู ูุชุงุฆุฌ ุงูุงุณุชุฑุฌุงุน ูุคูุชูุง
   - ุชุฎุฒูู ุงููุณุชูุฏุงุช ุงููุฑุชุจุฉ ูุคูุชูุง
   - ุฅุถุงูุฉ Redis ููุชุฎุฒูู ุงููุคูุช ุงูููุฒุน

5. **ุงููุฑุงูุจุฉ**
   - ุฅุถุงูุฉ ุชุณุฌูู ุฃุญุฏุงุซ ุงูููุงุณ ุนู ุจูุนุฏ
   - ุชุชุจุน ููุงููุณ ุฃุฏุงุก ุงููููุงุก
   - ุฅุนุฏุงุฏ ุงูุชูุจููุงุช ูููุดู

6. **ุงูุฃูุงู**
   - ุฅุถุงูุฉ ุนุฒู workspace ูู ููุงุนุฏ Firestore
   - ุชุทุจูู ุชุญุฏูุฏ ุงููุนุฏู
   - ุฅุถุงูุฉ ุฅุฏุงุฑุฉ ููุงุชูุญ API

7. **ููููุงุช ูุงุฌูุฉ ุงููุณุชุฎุฏู**
   - ุจูุงุก ููุญุฉ ุชุญูู ุชูููุฐ ุงูุดุจูุฉ
   - ุฅุธูุงุฑ ุชุตูุฑ ุชุชุจุน ุงููููุงุก
   - ุนุฑุถ ุฑูุงุจุท ุงูุงุณุชุดูุงุฏุงุช

## ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู

### ุงุณุชุนูุงู ุฃุณุงุณู
```typescript
const result = await client.execute({
  goal: "ูุง ูู ุงูููุฒุงุช ุงูุฃูููุฉ ุงูุฑุฆูุณูุฉ ูู ุงููุฑุญูุฉ 49ุ",
  strategy: "critic"
});

console.log(result.final.content);
// ุงููุชูุฌุฉ: "ุงููุฑุญูุฉ 49 ุชุทุจู ุนุฏุฉ ููุฒุงุช ุฃูููุฉ ุฑุฆูุณูุฉ:
// 1. ุนุฒู workspace ุนุจุฑ ููุงุนุฏ Firestore
// 2. ุชุชุจุน ุงูุฃุฎุทุงุก ูุน ูุณุงุฑุงุช ุงูุชุฏููู
// 3. ุฅุฏุงุฑุฉ ุงูุญูุงุฏุซ ูุน RBAC..."

for (const citation of result.final.evidence ?? []) {
  console.log(`  ๐ ${citation.docId} (ุงูููุงุท: ${citation.score})`);
  console.log(`     ${citation.snippet}`);
}
```

### ุจุญุซ ุชูุฑุงุฑู
```typescript
const session1 = await client.execute({
  goal: "ููู ุฃููู ุจุฅุนุฏุงุฏ ุงูุชุทููุฑ ุงููุญููุ",
  strategy: "majority"
});

const session2 = await client.continue({
  sessionId: session1.sessionId,
  feedback: "ูุงุฐุง ุนู ุฅุนุฏุงุฏ ุงููุญุงููุ"
});

const session3 = await client.continue({
  sessionId: session1.sessionId,
  feedback: "ููู ุฃููู ุจุจุฐุฑ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑุ"
});
```

## ุงูุญุงูุฉ

โ **ุงููุฑุญูุฉ 60 ููุชููุฉ**

ุฌููุน ุงูููููุงุช ูููุฐุฉ ูุน ููุทู ูุคูุช. ุฌุงูุฒ ูุชุญุณููุงุช ุงูุฅูุชุงุฌ:

- ุชูุงูู ุงูุจุญุซ ุงููุชุฌูู
- ุฎูุงุฑุฒููุงุช ุงูุฅุฌูุงุน ุงููุชูุฏูุฉ
- Streaming API
- ุงููุฑุงูุจุฉ ูุงูููุงุณ ุนู ุจูุนุฏ
- ููููุงุช ูุงุฌูุฉ ุงููุณุชุฎุฏู

## ุฏููู ุณุฑูุน

1. **ุชุดุบูู ุฎุงุฏู ุงูุชุทููุฑ:**
   ```bash
   PORT=3030 pnpm dev
   ```

2. **ุงุฎุชุจุงุฑ ููุทุฉ ููุงูุฉ API:**
   ```bash
   curl -X POST http://localhost:3030/api/mesh/execute \
     -H "Authorization: Bearer YOUR_FIREBASE_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"goal":"ุงุดุฑุญ ููู ูุนูู ุงูุชุนุงูู","strategy":"critic"}'
   ```

3. **ุงุณุชุฎุฏุงู SDK ูู ุงูููุฏ:**
   ```typescript
   import { createMeshClient } from "@/sdk/meshClient";

   const client = createMeshClient();
   const result = await client.execute({
     goal: "ููู ุฃููู ุจุงููุดุฑ ุฅูู ุงูุฅูุชุงุฌุ",
     strategy: "critic"
   });
   ```

## ููุงุญุธุงุช ูููุฉ

- ุฌููุน ุงููููุงุก ุชุณุชุฎุฏู ุญุงูููุง ููุทู ูุคูุช
- ุงูููุณุชุฑุฌุน ููุฑุฌุน ูุณุชูุฏุงุช ููููุฉ (TODO: ุฏูุฌ Vertex AI)
- ุงูููุฑุชุจ ูุณุชุฎุฏู ูุทุงุจูุฉ ูููุงุช ููุชุงุญูุฉ ุจุณูุทุฉ (TODO: ุงูุชุดุงุจู ุงูุฏูุงูู)
- ูุงูู ุงูุฐุงูุฑุฉ ูู ุงูุฐุงูุฑุฉ ููุท (TODO: Redis ููุฅูุชุงุฌ)
- ูุง ููุฌุฏ ุชุทุจูู ููุจุซ ุจุนุฏ (TODO: SSE)
- ุงูุงุฎุชุจุงุฑุงุช ุชุชุญูู ูู ุนููุฏ APIุ ูููุณ ููุทู ุงูุฅูุชุงุฌ

## ุงูุงุนุชูุงุฏุงุช

ุชู ุฅููุงู ุชูููุฐ ุงููุฑุญูุฉ 60 ูู 2025-11-07.

**ุงูุจููุฉ ุงููุนูุงุฑูุฉ:** ุดุจูุฉ ูุนุฑููุฉ ูุชุนุฏุฏุฉ ุงููููุงุก ูุน RAG
**ุงุณุชุฑุงุชูุฌูุงุช ุงูุฅุฌูุงุน:** ุงูุชุตููุช ุงูุฃุบูุจู ูุงูุชุญูู ูู ุงููุงูุฏ
**ุงูุชุฎุฒูู:** Firestore ููุฌูุณุงุชุ Vector DB ููู embeddings (TODO)
**ุงูุชูุงุตู:** ูุงูู ุฑุณุงุฆู ูู ุงูุฐุงูุฑุฉ ูุน ููุท pub/sub
