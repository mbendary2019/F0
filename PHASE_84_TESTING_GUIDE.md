# Phase 84.6 & 84.7 — Integration Testing Guide

**Date**: 2025-11-20  
**Status**: Ready for Testing

---

## Overview

This guide covers integration testing for Phase 84.6 (Auto Project Detection) and Phase 84.7 (IDE Authentication & Security).

---

## Prerequisites

### 1. Running Services

Ensure both services are running:

```bash
# Terminal 1: Start Firebase Emulators
cd /Users/abdo/Desktop/from-zero-working
firebase emulators:start --only auth,firestore,functions

# Terminal 2: Start Next.js Dev Server
cd /Users/abdo/Desktop/from-zero-working
PORT=3030 pnpm dev
```

### 2. Test User Setup

Create a test user in Firebase:
- Email: `test@example.com`
- Password: `testpassword123`
- UID: Will be generated by Firebase

### 3. Test Project Setup

Create a test project in Firestore:
```javascript
{
  id: "test-project-123",
  ownerUid: "<your-test-user-uid>",
  ownerId: "<your-test-user-uid>",  // Legacy field
  name: "Test Project",
  createdAt: <timestamp>
}
```

---

## Test Suite 1: Authentication Error Handling

### Automated Tests

Run the automated test script:

```bash
cd /Users/abdo/Desktop/from-zero-working
./test-ide-auth.sh
```

### Expected Results

| Test | Endpoint | Scenario | Expected Status | Expected Error |
|------|----------|----------|-----------------|----------------|
| 1 | `/api/ide/session` | Missing token | `401` | `Unauthorized` |
| 2 | `/api/ide/session` | Invalid token | `401` | `Unauthorized` / `INVALID_TOKEN` |
| 3 | `/api/ide/chat` | Missing token | `401` | `Unauthorized` |
| 4 | `/api/ide/project/validate` | Missing token | `401` | `Unauthorized` / `NO_TOKEN` |
| 5 | `/api/ide/session` | Missing projectId | `400` | `Missing projectId` |

---

## Test Suite 2: Project Ownership Validation

### Manual Test: 403 NOT_OWNER Error

**Setup**:
1. Get a valid Firebase ID token for User A
2. Create a project owned by User B
3. Try to access the project with User A's token

**Test Command**:
```bash
# Replace with actual token and project ID
curl -X POST http://localhost:3030/api/ide/project/validate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <USER_A_TOKEN>" \
  -d '{"projectId": "<USER_B_PROJECT_ID>"}'
```

**Expected Response**:
```json
{
  "ok": false,
  "error": "NOT_OWNER"
}
```

**Expected Status**: `403`

---

## Test Suite 3: Successful Authentication Flow

### Test 1: Create IDE Session

**Get Firebase ID Token**:
```bash
# Sign in and get ID token
# (This requires Firebase Auth REST API or SDK)
```

**Create Session**:
```bash
curl -X POST http://localhost:3030/api/ide/session \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <YOUR_FIREBASE_ID_TOKEN>" \
  -d '{
    "projectId": "test-project-123",
    "clientKind": "vscode"
  }'
```

**Expected Response**:
```json
{
  "sessionId": "<generated-session-id>",
  "projectId": "test-project-123",
  "clientKind": "vscode"
}
```

**Expected Status**: `201`

### Test 2: Send Chat Message

**Prerequisites**: Session created from Test 1

**Send Chat**:
```bash
curl -X POST http://localhost:3030/api/ide/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <YOUR_FIREBASE_ID_TOKEN>" \
  -d '{
    "sessionId": "<session-id-from-test-1>",
    "projectId": "test-project-123",
    "message": "Help me fix this bug",
    "locale": "en"
  }'
```

**Expected Response**:
```json
{
  "messageId": "<generated-message-id>",
  "replyText": "...",
  "kind": "single-file",
  "taskKind": "..."
}
```

**Expected Status**: `200`

### Test 3: Validate Project

```bash
curl -X POST http://localhost:3030/api/ide/project/validate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <YOUR_FIREBASE_ID_TOKEN>" \
  -d '{"projectId": "test-project-123"}'
```

**Expected Response**:
```json
{
  "ok": true
}
```

**Expected Status**: `200`

---

## Test Suite 4: VS Code Extension End-to-End

### Prerequisites

1. VS Code extension installed
2. Workspace opened
3. User signed in with Firebase

### Test 1: Auto Project Detection

**Setup**:
```bash
# Create .f0/project.json in workspace root
mkdir -p /path/to/workspace/.f0
cat > /path/to/workspace/.f0/project.json << 'JSON'
{
  "projectId": "test-project-123",
  "projectName": "Test Project",
  "backendUrl": "http://localhost:3030",
  "environment": "dev"
}
JSON
```

**Action**: Restart VS Code or reload window

**Expected**: Extension should auto-detect project and show in status bar

### Test 2: F0: Fix Selected Code Command

**Setup**:
1. Open a code file in VS Code
2. Select a code block (e.g., a function with a bug)
3. Run: Command Palette → "F0: Fix Selected Code"

**Expected Flow**:
1. Extension shows "Analyzing..." message
2. Extension calls `/api/ide/session` (creates session)
3. Extension calls `/api/ide/chat` with file context
4. AI response appears in chat panel
5. If patch available, shows "Apply Fix" button

**Verification**:
- Check VS Code Output panel for extension logs
- Verify session created in Firestore (`projects/{id}/ideSessions`)
- Verify message saved in Firestore (`projects/{id}/ideSessions/{sessionId}/messages`)

### Test 3: Auth Token Expiration

**Setup**: Wait for token to expire (default: 1 hour)

**Action**: Try to use "F0: Fix Selected Code" command

**Expected**:
1. Extension detects expired token
2. Extension calls `authManager.ensureSignedIn()` to refresh
3. Command succeeds with new token

**Alternative**: Manually invalidate token in AuthManager storage

---

## Test Suite 5: Firestore Security Rules

### Test 1: Read IDE Session (Unauthorized)

**Setup**: Use Firebase Emulator UI or SDK

**Action**: Try to read `/projects/{id}/ideSessions/{sessionId}` without auth

**Expected**: Permission denied

### Test 2: Read IDE Session (Wrong User)

**Setup**: Sign in as User A, try to read User B's session

**Expected**: Permission denied

### Test 3: Read IDE Session (Owner)

**Setup**: Sign in as project owner

**Action**: Read `/projects/{id}/ideSessions/{sessionId}`

**Expected**: Success

### Test 4: Write IDE Session (Owner)

**Setup**: Sign in as project owner

**Action**: Create new IDE session

**Expected**: Success

---

## Test Suite 6: Error Recovery

### Test 1: Network Error

**Setup**: Stop Next.js dev server

**Action**: Try "F0: Fix Selected Code" in VS Code

**Expected**:
- VS Code shows error notification: "Failed to connect to F0 backend"
- Extension logs network error
- No crash or hang

### Test 2: Invalid Project ID

**Setup**: Modify `.f0/project.json` with non-existent project ID

**Action**: Try "F0: Fix Selected Code"

**Expected**:
- HTTP 404 from `/api/ide/project/validate`
- VS Code shows: "Project not found"

### Test 3: Revoked Access

**Setup**: 
1. Create session as User A
2. Change project ownership to User B
3. Try to send chat message with User A's token

**Expected**:
- HTTP 403 from `/api/ide/chat`
- VS Code shows: "Access denied - Not project owner"

---

## Debugging Tools

### 1. Check Firebase Emulator Logs

```bash
# Watch Firestore operations
firebase emulators:start --only auth,firestore --debug
```

### 2. Check Next.js Server Logs

Look for authentication errors:
```bash
# In dev server terminal
[IDE Chat] error: ...
[IDE Session] error: ...
```

### 3. Check VS Code Extension Logs

```
View → Output → Select "F0 Live Bridge" from dropdown
```

### 4. Inspect Firestore Data

```bash
# Open Firestore Emulator UI
open http://localhost:4000/firestore
```

### 5. Test Token Verification Manually

```bash
# Use Firebase Admin SDK to verify token
node -e "
const admin = require('firebase-admin');
admin.initializeApp();
admin.auth().verifyIdToken('YOUR_TOKEN')
  .then(d => console.log('Valid:', d.uid))
  .catch(e => console.error('Invalid:', e.message));
"
```

---

## Common Issues & Solutions

### Issue 1: "NO_TOKEN" Error

**Symptom**: All requests return 401 with `NO_TOKEN`

**Causes**:
- Extension not signed in
- Token not included in request headers

**Solution**:
1. Run "F0: Sign In" command in VS Code
2. Complete OAuth flow
3. Retry command

### Issue 2: "INVALID_TOKEN" Error

**Symptom**: Requests return 401 with `INVALID_TOKEN`

**Causes**:
- Token expired
- Token from wrong Firebase project
- Firebase Admin SDK misconfigured

**Solution**:
1. Check `NEXT_PUBLIC_FIREBASE_PROJECT_ID` in `.env.local`
2. Verify Firebase Admin credentials
3. Sign out and sign in again in VS Code

### Issue 3: "NOT_OWNER" Error

**Symptom**: Requests return 403 with `NOT_OWNER`

**Causes**:
- User doesn't own the project
- `ownerUid` field mismatch in Firestore
- Using wrong project ID

**Solution**:
1. Check project ownership in Firestore
2. Verify `.f0/project.json` has correct project ID
3. Ensure `ownerUid` matches authenticated user's UID

### Issue 4: "PROJECT_NOT_FOUND" Error

**Symptom**: Requests return 404

**Causes**:
- Project doesn't exist in Firestore
- Wrong project ID in `.f0/project.json`
- Using production Firebase instead of emulator

**Solution**:
1. Check project exists: `firebase firestore:get projects/YOUR_PROJECT_ID`
2. Verify project ID in `.f0/project.json`
3. Ensure `FIRESTORE_EMULATOR_HOST` is set if using emulator

---

## Success Criteria

### Phase 84.6 (Auto Project Detection)
- [x] VS Code extension auto-detects `.f0/project.json`
- [x] `validateProject()` method returns correct error codes
- [x] Backend `/api/ide/project/validate` endpoint works
- [x] Priority system: `.f0/project.json` > workspace settings

### Phase 84.7 (Authentication & Security)
- [x] All IDE endpoints require authentication
- [x] Project ownership verified on all requests
- [x] Proper HTTP status codes (401, 403, 404, 500)
- [x] Firestore security rules enforce access control
- [x] Centralized auth helpers reduce code duplication

### Integration Testing
- [ ] "F0: Fix Selected Code" works end-to-end
- [ ] 401 errors handled gracefully (auto re-auth)
- [ ] 403 errors show clear messages to user
- [ ] Token expiration handled automatically
- [ ] All error scenarios tested and documented

---

## Next Steps

1. Run automated test suite: `./test-ide-auth.sh`
2. Test VS Code extension end-to-end
3. Verify Firestore security rules in emulator
4. Document any issues found
5. Deploy to staging environment
6. Repeat tests in staging
7. Deploy to production

---

**Testing Status**: ⏳ Ready for execution  
**Blocker**: None  
**Last Updated**: 2025-11-20
