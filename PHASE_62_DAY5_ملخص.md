# ุงููุฑุญูุฉ 62 โ ูุงุฌูุฉ Timeline โข ุงูููู 5 ููุชูู โ

## ูุธุฑุฉ ุนุงูุฉ

ุงูููู 5 ูู ุงููุฑุญูุฉ 62 ูุถูู ููุฒุงุช ูุชูุฏูุฉ ููุชุญุฏูุซุงุช ุงูููุฑูุฉ ูุฃุฏูุงุช ุฅูุชุงุฌูุฉ:

- โ **ุชุญุฏูุซุงุช ููุฑูุฉ** ุนุจุฑ ูุณุชูุนุงุช Firestore
- โ **ุชุตุฏูุฑ CSV ูุฌูุณุฉ ูุงุญุฏุฉ** ุจุชูุณูู ูุญุณูู
- โ **ุฑุณูู ุจูุงููุฉ ูุชูุฏูุฉ** ูุน ุฎูุงุฑุงุช ุงูุชุฌููุน ูุงูุชูุฏูุณ
- โ **ูุธุงู ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ููููุงุชุฑ** ูุน ุญูุธ ูุญูู
- โ **ุงุฎุชุจุงุฑุงุช ุดุงููุฉ** ูุฌููุน ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

---

## ุงูููุฒุงุช ุงููููุฐุฉ

### 1. ุงูุชุญุฏูุซุงุช ุงูููุฑูุฉ

**ุงูููู**: `src/hooks/useTimelineFeed.ts` (169 ุณุทุฑ)

Hook ูุฎุตุต ูุดุชุฑู ูู ูุฌููุนุฉ `ops_events` ุนูู Firestore ููุชุญุฏูุซุงุช ุงููุจุงุดุฑุฉ.

**ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ**:
- ูุณุชูุน `onSnapshot` ูู Firestore ูุน ุชูุธูู ุชููุงุฆู
- ุฏุนู ุฌููุน ุฃููุงุน ุงูููุงุชุฑ (sessionIdุ strategyุ typeุ ูุทุงู ุงูุชุงุฑูุฎ)
- ุจูุงุก ุงุณุชุนูุงูุงุช ูุฑูุจุฉ ูุน `orderBy` ู `limit`
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุญุงูุงุช ุงูุชุญููู

**ูุซุงู ุงูุงุณุชุฎุฏุงู**:
```typescript
import { useTimelineFeed } from "@/hooks/useTimelineFeed";

function MyComponent() {
  const { items, loading, error } = useTimelineFeed({
    sessionId: "sess_123",
    strategy: "critic",
  }, 500);

  if (loading) return <div>ุฌุงุฑู ุงูุชุญููู...</div>;
  if (error) return <div>ุฎุทุฃ: {error}</div>;

  return <div>{items.length} ุญุฏุซ (ูุจุงุดุฑ)</div>;
}
```

---

### 2. ุชุตุฏูุฑ CSV ููุฌูุณุฉ ุงููุงุญุฏุฉ

**ุงูููู**: `src/utils/exportSession.ts` (ูุญุณูู ูุน `exportSessionCsv`)

ูุตุฏูุฑ ุฃุญุฏุงุซ **ุฌูุณุฉ ูุงุญุฏุฉ ููุท** ุจุชูุณูู CSV ูุญุณูู.

**ุงูุชุญุณููุงุช**:
- ูููุชุฑ ุงูุฃุญุฏุงุซ ุญุณุจ `sessionId` ุชููุงุฆููุง
- ูุฑุชุจ ุฒููููุง (`ts` ุชุตุงุนุฏู)
- ูุชุถูู ุงูุทุงุจุน ุงูุฒููู Unix ูุชูุณูู ISO
- ุนููุฏ `meta` ูุฎุตุต ูุน JSON ูุงูู
- ูุนุงูุฌุฉ ุตุญูุญุฉ ูุนูุงูุงุช ุงูุงูุชุจุงุณ/ุงูููุงุตู/ุฃุณุทุฑ ุฌุฏูุฏุฉ

**ุชูุณูู CSV**:
```csv
ts,timestamp_iso,level,type,strategy,message,meta
1699900000000,"2023-11-13T12:00:00.000Z","info","rag.validate","critic","Validation passed","{\"score\":0.95}"
```

**ุงูุงุณุชุฎุฏุงู**:
```typescript
import { exportSessionCsv } from "@/utils/exportSession";

// ุงูุชุตุฏูุฑ ูู SessionModal
<button onClick={() => exportSessionCsv(sessionId, events)}>
  ๐ Session CSV
</button>
```

**ุงูุชูุงูู**:
- ุฃูุถูู ุฅูู [SessionModal.tsx:137](src/components/timeline/SessionModal.tsx#L137) ูุฒุฑ "๐ Session CSV"
- ูุธูุฑ ุจุฌุงูุจ ุฃุฒุฑุงุฑ ุชุตุฏูุฑ JSON/CSV
- ูููุนููู ููุท ุนูุฏ ุชุญููู ุจูุงูุงุช ุงูุฌูุณุฉ

---

### 3. TrendMini ุงููุญุณูู

**ุงูููู**: `src/components/timeline/TrendMini.tsx` (349 ุณุทุฑ)

ุฑุณู ุจูุงูู ูุชูุฏู ูู 24 ุณุงุนุฉ ูุน ุฎูุงุฑุงุช ุงูุชุฌููุน ูุงูุชูุฏูุณ.

**ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ**:

#### ุฃ) ูุญุฏุฏ ุงูุชุฌููุน (Binning Selector)
ุงุฎุชุฑ ุฏูุฉ ุชุฌููุน ุงูููุช:
- **5 ุฏูุงุฆู** - ุฏูุฉ ุนุงููุฉ ูููุดุงุท ุงูุญุฏูุซ
- **15 ุฏูููุฉ** - ุฏูุฉ ูุชูุณุทุฉ
- **30 ุฏูููุฉ** - ุนุฑุถ ูุชูุงุฒู
- **60 ุฏูููุฉ** (ุงูุชุฑุงุถู) - ูุธุฑุฉ ุนุงูุฉ ุจุงูุณุงุนุฉ

#### ุจ) ุชุจุฏูู ุงูุชูุฏูุณ (Stack Toggle)
ุชุตูุฑ ุชูุฒูุน ุงูุฃุญุฏุงุซ:
- **Total** (ุงูุชุฑุงุถู) - ุฑุณู ุจูุงูู ุฎุทู ูุงุญุฏ ููุถุญ ุงูุนุฏุฏ ุงูุฅุฌูุงูู
- **By Level** - ุฑุณู ุจูุงูู ููุฏุณ ุญุณุจ ุงููุณุชูู (info/warn/error)
- **By Type** - ุฑุณู ุจูุงูู ููุฏุณ ุญุณุจ ููุน ุงูุญุฏุซ

**ุนูุงุตุฑ ุงูุชุญูู**:
```tsx
<TrendMini
  items={items}
  bucketMinutes={60}
  showBinSelector={true}
  showStackToggle={true}
/>
```

**ููุญุฉ ุงูุฃููุงู**:
- Info: `#60a5fa` (ุฃุฒุฑู)
- Warn: `#fbbf24` (ุฃุตูุฑ)
- Error: `#f87171` (ุฃุญูุฑ)
- Default: `#8b5cf6` (ุจููุณุฌู)

---

### 4. ูุธุงู ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ููููุงุชุฑ

**ุงููููุงุช**:
- `src/utils/timelinePresets.ts` (170 ุณุทุฑ)
- `src/components/timeline/PresetManager.tsx` (231 ุณุทุฑ)

ุงุญูุธ ูุญูููู ุชููููุงุช ุงูููุงุชุฑ ูุน ุงูุญูุธ ุงููุญูู (localStorage).

**ุงูููุฒุงุช**:

#### ุฅุฏุงุฑุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ
```typescript
// ุญูุธ ุงูููุงุชุฑ ุงูุญุงููุฉ
const preset = savePreset("ุฃุฎุทุงุก ุฐุงุช ุฃููููุฉ ุนุงููุฉ", {
  severity: "error",
  from: Date.now() - 86400000,
  strategy: "critic"
});

// ุชุญููู ุฅุนุฏุงุฏ ูุณุจู
const presets = loadPresets();
const myPreset = presets.find(p => p.name === "ุฃุฎุทุงุก ุฐุงุช ุฃููููุฉ ุนุงููุฉ");
applyFilters(myPreset.filters);

// ุญุฐู ุฅุนุฏุงุฏ ูุณุจู
deletePreset(preset.id);
```

#### ุงูุงุณุชูุฑุงุฏ/ุงูุชุตุฏูุฑ
```typescript
// ุชุตุฏูุฑ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ูู JSON
const json = exportPresets();
downloadFile("my-presets.json", json);

// ุงุณุชูุฑุงุฏ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ูู ููู
const count = importPresets(jsonString);
console.log(`ุชู ุงุณุชูุฑุงุฏ ${count} ุฅุนุฏุงุฏ ูุณุจู`);
```

**ุงูุชูุงูู ูู ุงููุงุฌูุฉ**:
- ุฃูุถูู ุฅูู [FiltersBar.tsx:141](src/components/timeline/FiltersBar.tsx#L141)
- ุฒุฑ "๐พ Presets" ูู ุดุฑูุท ุงูููุงุชุฑ
- ูุงุฆูุฉ ููุณุฏูุฉ ูุน ุฅุฌุฑุงุกุงุช ุงูุญูุธ/ุงูุชุญููู/ุงูุญุฐู
- ูุนุฑุถ ุนุฏุฏ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ: "Presets (3)"

---

## ุงููููุงุช ุงููููุดุฃุฉ/ุงูููุนุฏูููุฉ

### ูููุงุช ุฌุฏูุฏุฉ (4)
1. `src/hooks/useTimelineFeed.ts` - Hook ูููุณุชูุน ุงูููุฑู ุนูู Firestore
2. `src/utils/timelinePresets.ts` - ุฃุฏูุงุช ุฅุฏุงุฑุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ
3. `src/components/timeline/PresetManager.tsx` - ูููู ูุงุฌูุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ
4. `__tests__/timeline_day5.spec.tsx` - ุงุฎุชุจุงุฑุงุช ุดุงููุฉ

### ูููุงุช ูุนุฏูุฉ (4)
1. `src/utils/exportSession.ts` - ุฃุถููุช ุฏุงูุฉ `exportSessionCsv`
2. `src/components/timeline/SessionModal.tsx` - ุฃูุถูู ุฒุฑ Session CSV
3. `src/components/timeline/TrendMini.tsx` - ูุญุณูู ูุน ุงูุชุฌููุน/ุงูุชูุฏูุณ
4. `src/components/timeline/FiltersBar.tsx` - ูุฏูุฌ ูุน PresetManager

**ุฅุฌูุงูู ุงูุฃุณุทุฑ ุงููุถุงูุฉ**: ~950 ุณุทุฑ

---

## ุงูุงุฎุชุจุงุฑุงุช

### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช
```bash
# ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูููู 5
pnpm test __tests__/timeline_day5.spec.tsx

# ุชุดุบูู ุฌููุน ุงุฎุชุจุงุฑุงุช timeline
pnpm test __tests__/timeline
```

### ุงูุชุบุทูุฉ ุงูุงุฎุชุจุงุฑูุฉ

**ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ** (10 ุงุฎุชุจุงุฑุงุช):
- โ ุญูุธ ูุชุญููู ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ
- โ ุชุญุฏูุซ ุฅุนุฏุงุฏ ูุณุจู ููุฌูุฏ
- โ ุญุฐู ุฅุนุฏุงุฏ ูุณุจู
- โ ุชุตุฏูุฑ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ูู JSON
- โ ุงุณุชูุฑุงุฏ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ูู JSON
- โ ููุน ุงูุงุณุชูุฑุงุฏ ุงูููุฑุฑ
- โ ุนุฑุถ ุฒุฑ PresetManager
- โ ุนุฑุถ ุนุฏุฏ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ
- โ ูุชุญ ุงููุงุฆูุฉ ุนูุฏ ุงูููุฑ
- โ callback ุชุญููู ุงูุฅุนุฏุงุฏ ุงููุณุจู

**ุชุตุฏูุฑ CSV ููุฌูุณุฉ** (3 ุงุฎุชุจุงุฑุงุช):
- โ ุชุตุฏูุฑ ุฃุญุฏุงุซ ุงูุฌูุณุฉ ูู CSV
- โ ููุชุฑุฉ ุงูุฃุญุฏุงุซ ุญุณุจ ูุนุฑู ุงูุฌูุณุฉ
- โ ุชูุจูู ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุญุฏุงุซ

**ุงูุฅุฌูุงูู**: 13 ุงุฎุชุจุงุฑ ุขูู

---

## ุฏููู ุงูุงุณุชุฎุฏุงู

### ุงูุงุณุชุฎุฏุงู ุงูุฃุณุงุณู ููู Timeline

```typescript
import { useTimeline } from "@/hooks/useTimeline";
import { useTimelineFeed } from "@/hooks/useTimelineFeed";

function TimelinePage() {
  // ุงูุฎูุงุฑ 1: REST API (ุฏุนู ุงูุชุฑููู)
  const { items, loading, hasMore, loadMore } = useTimeline({
    sessionId: "sess_123",
    limit: 100
  });

  // ุงูุฎูุงุฑ 2: Firestore ุงูููุฑู (ุชุญุฏูุซุงุช ูุจุงุดุฑุฉ)
  const { items: liveItems, loading, error } = useTimelineFeed({
    sessionId: "sess_123"
  }, 500);

  return (
    <TimelineList items={liveItems} />
  );
}
```

### ุณูุฑ ุนูู ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ

1. **ุทุจููู ุงูููุงุชุฑ** (sessionIdุ strategyุ typeุ ูุทุงู ุงูุชุงุฑูุฎ)
2. **ุงููุฑ ุนูู ุฒุฑ "๐พ Presets"**
3. **ุงููุฑ ุนูู "๐พ Save Current Filters"**
4. **ุฃุฏุฎู ุงุณู ุงูุฅุนุฏุงุฏ ุงููุณุจู** (ูุซู: "ุฃุฎุทุงุก ุขุฎุฑ 24 ุณุงุนุฉ")
5. **ุงููุฑ ุนูู "Save"**

ููุชุญููู ูุงุญููุง:
1. ุงููุฑ ุนูู "๐พ Presets"
2. ุงููุฑ ุนูู ุงุณู ุงูุฅุนุฏุงุฏ ุงููุณุจู
3. ุชูุทุจููู ุงูููุงุชุฑ ููุฑูุง

### ุชุตุฏูุฑ ุจูุงูุงุช ุงูุฌูุณุฉ

**ูู SessionModal**:
1. ุงููุฑ ุนูู ุฃู ุญุฏุซ ูู timeline
2. ููุชุญ modal ุชูุงุตูู ุงูุฌูุณุฉ
3. ุงููุฑ ุนูู **"๐ Session CSV"** ููุชุตุฏูุฑ ุงูุฎุงุต ุจุฌูุณุฉ ูุงุญุฏุฉ
4. ุฃู ุงููุฑ ุนูู **"๐ JSON"** / **"๐ CSV"** ููุชุตุฏูุฑ ุงููุงูู

**ุงููุฑูู ูู CSV**:
- **Session CSV**: ุฃุญุฏุงุซ ูุฐู ุงูุฌูุณุฉ ููุทุ ุชูุณูู ูุญุณูู
- **CSV ุงูุนุงุฏู**: ุฌููุน ุงูุฃุญุฏุงุซ ูุน ุฃุนูุฏุฉ ุฃุณุงุณูุฉ

---

## ุฅุนุฏุงุฏ Firestore

### ุงูููุงุฑุณ ุงููุทููุจุฉ

ุฃูุดุฆ ููุงุฑุณ ูุฑูุจุฉ ูู Firebase Console ุฃู ุนุจุฑ `firestore.indexes.json`:

```json
{
  "indexes": [
    {
      "collectionGroup": "ops_events",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "sessionId", "order": "ASCENDING" },
        { "fieldPath": "ts", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "ops_events",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "strategy", "order": "ASCENDING" },
        { "fieldPath": "ts", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "ops_events",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "type", "order": "ASCENDING" },
        { "fieldPath": "ts", "order": "DESCENDING" }
      ]
    }
  ]
}
```

ูุดุฑ ุงูููุงุฑุณ:
```bash
firebase deploy --only firestore:indexes
```

---

## ููุงุญุธุงุช ุงูุฃุฏุงุก

### ุงูุชุบุฐูุฉ ุงูููุฑูุฉ (Real-time Feed)
- **ุงูุญุฏ**: 500 ุนูุตุฑ ุงูุชุฑุงุถููุงุ ูุงุจู ููุชูููู ุนุจุฑ ูุนุงูู `maxItems`
- **ุงูุฐุงูุฑุฉ**: ~1-2 ููููุจุงูุช ููู ุญุฏุซ (500 ุญุฏุซ โ 1 ููุฌุงุจุงูุช)
- **ุงูุดุจูุฉ**: ุฌูุจ ุฃููู + ุชุญุฏูุซุงุช ุงููุฑูู ููุท
- **ุงูุชูุธูู**: ุฅูุบุงุก ุงูุงุดุชุฑุงู ุงูุชููุงุฆู ุนูุฏ ุงูุฅุฒุงูุฉ

### ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ
- **ุงูุชุฎุฒูู**: ~500 ุจุงูุช ููู ุฅุนุฏุงุฏ ูุณุจู (localStorage)
- **ุงูุญุฏ**: ~5 ููุฌุงุจุงูุช ุฅุฌูุงูู (ุญุฏ localStorage ูู ุงููุชุตูุญ)
- **ุงูุชูุฏูุฑ**: ~10,000 ุฅุนุฏุงุฏ ูุณุจู ูุญุฏ ุฃูุตู (ุบูุฑ ููุตู ุจู)

### TrendMini
- **ุงูุชุฌููุน**: ุชุนููุฏ O(n)ุ ูุฎุฒูู ูุคูุชูุง ุนุจุฑ `useMemo`
- **ุนุฑุถ ุงูุฑุณู ุงูุจูุงูู**: ุฌุงูุจ ุงูุนููู ููุท (ูุง ุญูู SSR)
- **ุชุฌููุน 5 ุฏูุงุฆู**: 288 ุฏูู ููู 24 ุณุงุนุฉ
- **ุชุฌููุน 60 ุฏูููุฉ**: 24 ุฏูู ููู 24 ุณุงุนุฉ

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ุชุญุณููุงุช ุงุฎุชูุงุฑูุฉ

1. **ูุฒุงููุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ุนุจุฑ ุงูุณุญุงุจุฉ**
   - ุชุฎุฒูู ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ูู ูุฌููุนุฉ Firestore `ops_timeline_presets`
   - ุงููุฒุงููุฉ ุนุจุฑ ุงูุฃุฌูุฒุฉ ูููุณ ุงููุณุชุฎุฏู
   - ูุดุงุฑูุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุณุจูุฉ ุฏุงุฎู ุงููุคุณุณุฉ

2. **ููุงุชุฑ ูุชูุฏูุฉ**
   - ุจุญุซ ูุตู ูุงูู ูู ุชุณููุงุช ุงูุฃุญุฏุงุซ
   - ูุทุงุจูุฉ ุฃููุงุท regex
   - ุชุญุฏูุฏ ูุชุนุฏุฏ ููุงุณุชุฑุงุชูุฌูุงุช/ุงูุฃููุงุน

3. **ุชุญุณููุงุช ุงูุชุตุฏูุฑ**
   - ุชูุณูู ุชุตุฏูุฑ Excel (XLSX)
   - ุฅูุดุงุก ุชูุงุฑูุฑ PDF
   - ุชูุงุฑูุฑ ูุฌุฏููุฉ ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู

4. **ุชุญููู ุงูุงุชุฌุงูุงุช**
   - ูุดู ุงูุดุฐูุฐ (ุชูุจููุงุช ุงูุงุฑุชูุงุน ุงูููุงุฌุฆ)
   - ููุงุฑูุฉ ุงูุงุชุฌุงูุงุช (ุฃุณุจูุน ุจุฃุณุจูุน)
   - ุงูุชูุจุค (ุชููุน ุงูุงุชุฌุงูุงุช ุงููุณุชูุจููุฉ)

---

## ุงูููุฎุต

ุงููุฑุญูุฉ 62 ุงูููู 5 ุชููุฐ ุจูุฌุงุญ:

โ **ุชุญุฏูุซุงุช ููุฑูุฉ** - ูุณุชูุนุงุช Firestore ุงููุจุงุดุฑุฉ
โ **ุชุตุฏูุฑ CSV ููุฌูุณุฉ** - ุชูุณูู ูุญุณูู ูุฌูุณุฉ ูุงุญุฏุฉ
โ **ุงุชุฌุงูุงุช ูุญุณููุฉ** - ุฎูุงุฑุงุช ุงูุชุฌููุน + ุงูุชูุฏูุณ
โ **ุฅุนุฏุงุฏุงุช ูุณุจูุฉ ููููุงุชุฑ** - ุญูุธ/ุชุญููู ูุน localStorage
โ **ุงุฎุชุจุงุฑุงุช ูุงููุฉ** - 13 ุญุงูุฉ ุงุฎุชุจุงุฑ ุขููุฉ

**ุงูุฅุฌูุงูู**: 4 ูููุงุช ุฌุฏูุฏุฉุ 4 ูููุงุช ูุนุฏูุฉุ ~950 ุณุทุฑ ูู ุงูููุฏ

ูุงุฌูุฉ Timeline ุงูุขู ุฌุงูุฒุฉ ููุฅูุชุงุฌ ูุน ููุฒุงุช ูุชูุฏูุฉ ูููุณุชุฎุฏููู ุงููุชูุฑุณูู ููุฑู ุงูุนูููุงุช.

---

**ุงูุญุงูุฉ**: โ **ููุชูู**
**ุงูุชุงุฑูุฎ**: 2025-11-07
**ุงููุฑุญูุฉ**: 62 ุงูููู 5
**ุงูุชุงูู**: ุงููุฑุญูุฉ 62 ุงูููู 6 (ุฅุฐุง ูุฒู ุงูุฃูุฑ) ุฃู ุงููุฑุญูุฉ 63
