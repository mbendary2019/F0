# âœ… Phase 104.4: Ask Agent to Implement Task - COMPLETE

**Date**: 2025-11-27
**Status**: âœ… **SKELETON IMPLEMENTATION COMPLETE**

---

## ğŸ¯ Goal

Add the ability for users to delegate task execution to the agent by clicking a button. This is a **skeleton implementation** that:
- Creates a `queued_action` in Firestore
- Marks the task as `in_progress`
- Auto-completes the task after 2 seconds
- Adds a system message to chat

**TODO for Future**: Integrate with real Code Agent for actual task implementation.

---

## âœ… What Was Implemented

### 1ï¸âƒ£ Updated TypeScript Types

**File**: [src/types/project.ts](src/types/project.ts) (Lines 172-190)

**Changes**:
```typescript
export type F0ActionStatus = 'pending' | 'in_progress' | 'completed' | 'failed';

export interface F0QueuedAction {
  id?: string;
  projectId: string;
  type: 'preflight' | 'execute_task';
  phaseId?: string;
  taskId?: string;
  taskTitle?: string;
  status: F0ActionStatus;
  createdAt: number;
  startedAt?: number | null;
  completedAt?: number | null;
  lastError?: string | null;
}
```

**What Changed**:
- Added `F0ActionStatus` type export
- Made `id` optional (auto-generated by Firestore)
- Added `projectId` (required for querying)
- Added `phaseId` and `taskId` for better tracking
- Renamed `processedAt` â†’ `startedAt` and `completedAt`
- Changed `error` â†’ `lastError` with `null` type

---

### 2ï¸âƒ£ Created API Endpoint

**File**: [src/app/api/f0/run-next-task/route.ts](src/app/api/f0/run-next-task/route.ts)

**Endpoint**: `POST /api/f0/run-next-task`

**Request Body**:
```json
{
  "projectId": "QNnGNj3QRLlaVwg9y8Lz",
  "taskId": "task-123"
}
```

**Response** (Success):
```json
{
  "ok": true,
  "actionId": "action-abc",
  "taskId": "task-123",
  "message": "Task execution started (skeleton implementation)"
}
```

**What It Does**:

1. **Authenticates user** via Firebase ID token
2. **Verifies project ownership** (checks `ownerUid`)
3. **Gets task details** from Firestore
4. **Finds or creates queued_action**:
   - Checks if action already exists for this task
   - Creates new action if not found
5. **Marks action as `in_progress`**:
   - Sets `startedAt` timestamp
6. **Marks task as `in_progress`**:
   - Updates task status
7. **Executes task** (skeleton):
   - Uses `setTimeout` to simulate 2-second work
   - Marks task as `completed`
   - Marks action as `completed`
   - Adds system message to chat
8. **Returns success response**

**Security**:
- âœ… Requires authentication
- âœ… Verifies project ownership
- âœ… Returns 401 for unauthenticated users
- âœ… Returns 403 for unauthorized users
- âœ… Returns 404 for missing project/task

**Error Handling**:
- Catches errors during execution
- Marks action as `failed` with `lastError`
- Returns 500 for server errors

---

### 3ï¸âƒ£ Updated Continue Page UI

**File**: [src/app/[locale]/f0/projects/[id]/continue/page.tsx](src/app/[locale]/f0/projects/[id]/continue/page.tsx)

**New State Variables** (Lines 26-27):
```typescript
const [runningTaskId, setRunningTaskId] = useState<string | null>(null);
const [runError, setRunError] = useState<string | null>(null);
```

**New Handler Function** (Lines 126-164):
```typescript
const handleRunTaskWithAgent = async (task: F0Task) => {
  setRunError(null);
  setRunningTaskId(task.id);

  try {
    const user = auth.currentUser;
    if (!user) {
      throw new Error('User not authenticated');
    }

    const token = await user.getIdToken();

    const res = await fetch('/api/f0/run-next-task', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({
        projectId,
        taskId: task.id,
      }),
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || 'Failed to start task');
    }

    console.log('[Phase 104.4] Task execution started:', data);
  } catch (error) {
    console.error('[Phase 104.4] Error running task:', error);
    setRunError(error instanceof Error ? error.message : 'Unknown error');
  } finally {
    setRunningTaskId(null);
  }
};
```

**New UI Button** (Lines 413-452):
```tsx
{/* Phase 104.4: Ask Agent Button */}
<div className="mt-3 pt-3 border-t border-[#2c1466]">
  <button
    onClick={(e) => {
      e.stopPropagation();
      handleRunTaskWithAgent(activeTask);
    }}
    disabled={runningTaskId === activeTask.id}
    className={/* gradient purple button */}
  >
    {runningTaskId === activeTask.id ? (
      <>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...</>
    ) : (
      <>ğŸ¤– Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ÙˆÙƒÙŠÙ„ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø©</>
    )}
  </button>

  {runError && (
    <div className="text-red-400 bg-red-500/10">
      Ø®Ø·Ø£: {runError}
    </div>
  )}

  <div className="text-gray-500">
    (Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© - Ø§Ù„Ù…Ù‡Ù…Ø© Ø³ØªÙØ¹Ù„Ù… ÙƒÙ…ÙƒØªÙ…Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)
  </div>
</div>
```

**Visual Design**:
- âœ… Purple gradient button (`from-purple-500 to-indigo-500`)
- âœ… Shadow effect on hover
- âœ… Disabled state when running (gray)
- âœ… Loading indicator (â³) while running
- âœ… Error display (red background)
- âœ… Helper text explaining skeleton behavior
- âœ… Bilingual support (Arabic/English)

---

## ğŸ”„ User Flow

### Scenario: User Asks Agent to Implement a Task

1. **User clicks on a task** â†’ Task details panel appears
2. **User clicks "Ask Agent to implement this task"**:
   - Button shows loading state: "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°..."
   - Button becomes disabled (gray)
3. **API call is made**:
   - User's Firebase ID token is sent
   - Server verifies authentication and ownership
4. **Server creates/updates queued_action**:
   - Finds existing action or creates new one
   - Marks action as `in_progress`
5. **Server marks task as `in_progress`**:
   - Task status changes in Firestore
   - Real-time listener updates UI immediately
6. **Server simulates execution** (2 seconds):
   - Skeleton implementation waits 2 seconds
   - Marks task as `completed`
   - Marks action as `completed`
   - Adds system message to chat
7. **User sees updates in real-time**:
   - Task status badge turns green ("Ù…ÙƒØªÙ…Ù„")
   - Phase progress bar increases
   - Chat panel shows system message
8. **Button returns to normal state**

---

## ğŸ§ª Testing

### Manual Testing Steps

1. **Open Continue Workspace**:
   ```
   http://localhost:3030/en/f0/projects/YOUR_PROJECT_ID/continue
   ```

2. **Click on a task** â†’ Task Details panel appears

3. **Click "Ask Agent to implement this task"**:
   - Should see loading state (â³)
   - Button should be disabled
   - Check browser console: `[Phase 104.4] Task execution started`

4. **Wait 2 seconds**:
   - Task status should change to "Completed"
   - Progress bar should update
   - Chat panel should show system message

5. **Check Firestore Console**:
   - `projects/{projectId}/queued_actions` should have new document
   - Action should have `status: 'completed'`
   - Task should have `status: 'completed'`

6. **Test Error Handling**:
   - Logout and try clicking button â†’ Should show "User not authenticated"
   - Change `projectId` to invalid value â†’ Should show error

---

## ğŸ“ Files Modified/Created

### Created Files:
1. âœ… [src/app/api/f0/run-next-task/route.ts](src/app/api/f0/run-next-task/route.ts) - API endpoint

### Modified Files:
1. âœ… [src/types/project.ts](src/types/project.ts) - Updated `F0QueuedAction` interface
2. âœ… [src/app/[locale]/f0/projects/[id]/continue/page.tsx](src/app/[locale]/f0/projects/[id]/continue/page.tsx) - Added button and handler

---

## ğŸ” Firestore Collections

### New Collection: `queued_actions`

**Path**: `projects/{projectId}/queued_actions/{actionId}`

**Document Structure**:
```typescript
{
  id: "action-abc",
  projectId: "proj-123",
  type: "execute_task",
  phaseId: "mvp",
  taskId: "task-456",
  taskTitle: "Implement user authentication",
  status: "completed",
  createdAt: 1732694400000,
  startedAt: 1732694401000,
  completedAt: 1732694403000,
  lastError: null
}
```

**Indexes Needed** (for production):
```
Collection: queued_actions
Fields: taskId (ASC), status (ASC)
```

---

## ğŸš€ What's Next: Real Code Agent Integration

### Current Skeleton Implementation:
```typescript
// Simulate execution
setTimeout(async () => {
  // Mark task as completed
  await adminDb.collection('projects').doc(projectId)
    .collection('tasks').doc(taskId)
    .update({ status: 'completed', completedAt: Date.now() });
}, 2000);
```

### TODO for Real Implementation:

Replace the `setTimeout` block with:

```typescript
// Import Code Agent client
import { CodeAgent } from '@/lib/codeAgent';

// Instead of setTimeout, call Code Agent
const agent = new CodeAgent();
const result = await agent.executeTask({
  projectId,
  taskId,
  taskTitle: task.title,
  taskDescription: task.description,
  phaseId: task.phaseId,
});

// Update task based on result
if (result.success) {
  await adminDb.collection('projects').doc(projectId)
    .collection('tasks').doc(taskId)
    .update({
      status: 'completed',
      completedAt: Date.now(),
      result: result.output,
    });
} else {
  await adminDb.collection('projects').doc(projectId)
    .collection('tasks').doc(taskId)
    .update({
      status: 'blocked',
      lastError: result.error,
    });
}
```

---

## ğŸ¨ Visual Design

### Button States

**Normal State**:
- Background: Purple-to-indigo gradient
- Text: White
- Shadow: Purple glow
- Hover: Darker gradient

**Loading State**:
- Background: Gray
- Text: Gray
- Icon: â³
- Cursor: `not-allowed`

**Error State**:
- Red text on red/10 background
- Shows error message below button

### Button Text (Bilingual)

| State | English | Arabic |
|-------|---------|--------|
| Normal | ğŸ¤– Ask Agent to implement this task | ğŸ¤– Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ÙˆÙƒÙŠÙ„ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© |
| Loading | â³ Running... | â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°... |
| Error | Error: {message} | Ø®Ø·Ø£: {message} |

---

## ğŸ“Š Real-time Updates Flow

```
User clicks "Ask Agent" button
    â†“
handleRunTaskWithAgent() called
    â†“
POST /api/f0/run-next-task
    â†“
Server creates/updates queued_action
    â†“
Server marks task as in_progress
    â†“
Real-time listener (onSnapshot) detects change
    â†“
UI updates: Task badge turns yellow
    â†“
Server simulates 2s execution (setTimeout)
    â†“
Server marks task as completed
    â†“
Real-time listener detects change again
    â†“
UI updates: Task badge turns green, progress bar increases
    â†“
Server adds system message to chat
    â†“
Chat panel shows new message
    â†“
All users see the update in real-time! ğŸš€
```

---

## ğŸ‰ Status: SKELETON COMPLETE

**Phase 104.4** is now operational with:

âœ… **TypeScript Types Updated**: `F0QueuedAction` interface matches requirements
âœ… **API Endpoint Created**: `POST /api/f0/run-next-task` handles task execution
âœ… **UI Button Added**: "Ask Agent" button with loading/error states
âœ… **Real-time Updates**: Tasks auto-update when completed
âœ… **Bilingual Support**: Arabic/English labels throughout
âœ… **Error Handling**: Authentication, authorization, and server errors handled

**Skeleton Implementation**: Tasks are marked as completed automatically after 2 seconds.

**TODO for Production**: Replace `setTimeout` with real Code Agent integration.

---

## ğŸ“ Quick Reference

### Test the Feature:
```bash
# 1. Open Continue workspace
open http://localhost:3030/en/f0/projects/YOUR_PROJECT_ID/continue

# 2. Click on a task â†’ Task Details panel appears

# 3. Click "Ask Agent to implement this task"

# 4. Wait 2 seconds â†’ Task marked as completed
```

### API Call Example:
```typescript
const token = await auth.currentUser.getIdToken();

const res = await fetch('/api/f0/run-next-task', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: `Bearer ${token}`,
  },
  body: JSON.stringify({
    projectId: 'proj-123',
    taskId: 'task-456',
  }),
});

const data = await res.json();
console.log(data);
// { ok: true, actionId: "action-abc", taskId: "task-456", message: "..." }
```

---

**Date Completed**: 2025-11-27
**Phase**: 104.4 - Ask Agent to Implement Task (Skeleton)
**Status**: âœ… SKELETON IMPLEMENTATION COMPLETE
**Next Step**: Integrate with real Code Agent for actual task execution

