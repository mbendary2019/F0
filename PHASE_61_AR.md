# المرحلة 61: طبقة التحقق المعرفي - مكتملة ✅

## نظرة عامة

تضيف المرحلة 61 **طبقة التحقق المعرفي** إلى نظام الشبكة المعرفية متعددة الوكلاء. تقوم هذه الطبقة الجديدة بالتحقق من صحة مخرجات الوكلاء من خلال تسجيل نقاط عبر أبعاد متعددة قبل قبولها كإجابات نهائية، مما يقلل بشكل كبير من الهلوسة ويحسن جودة الإجابات.

## ما تمت إضافته

### 1. وكيل التحقق (Validator Agent)

وكيل متخصص جديد يتحقق من المخرجات قبل قبولها كنهائية:

- **الملف**: `src/orchestrator/agents/roles/validatorAgent.ts`
- **الدور**: ناقد (متخصص في التحقق)
- **المسؤولية**: تسجيل نقاط للمخرجات على تغطية الاستشهادات، ومواءمة السياق، وجودة المصدر، والملاءمة
- **الإجراء**: يُرجع `CRITIQUE` للمخرجات منخفضة الجودة أو `FINAL` للإجابات المُتحقق منها

### 2. محرك التسجيل (Scoring Engine)

نظام تسجيل شامل مع 4 أبعاد:

**الملف**: `src/orchestrator/rag/scoring.ts`

#### أبعاد التسجيل

1. **تغطية الاستشهادات (وزن 35%)**
   - يقيس عدد الاستشهادات التي تدعم الإجابة
   - المزيد من الاستشهادات = درجة أعلى (حتى 6، ثم عوائد متناقصة)
   - صفر استشهادات = 0 نقطة

2. **مواءمة السياق (وزن 25%)**
   - يتحقق من انعكاس تلميحات السياق في المخرجات
   - يقارن التلميحات المقدمة مع محتوى الإجابة
   - نقاط محايدة عند عدم توفير تلميحات

3. **سمعة المصدر (وزن 20%)**
   - يقيّم جودة المصادر المُستشهد بها
   - يستخدم درجات السمعة من أنواع المصادر
   - متوسط سمعة جميع الاستشهادات

4. **الملاءمة (وزن 20%)**
   - يقيس التداخل في المصطلحات بين الاستعلام والمخرجات
   - تداخل أعلى = إجابة أكثر ملاءمة
   - يتطلب 3 مصطلحات متطابقة على الأقل للتسجيل العادل

**عتبة التحقق**: 0.55 (55%)
- المخرجات التي تحصل على درجة أقل من هذه يتم رفضها مع ملاحظات
- المخرجات التي تحصل على درجة أعلى يتم الموافقة عليها كـ FINAL

### 3. نظام سمعة المصدر

**الملف**: `src/orchestrator/rag/sourceReputation.ts`

يعين درجات سمعة (0-1) لأنواع مصادر مختلفة:

```typescript
{
  kb: 0.8,        // مقالات قاعدة المعرفة
  cluster: 0.7,   // مستندات المساحة/العنقود
  link: 0.6,      // روابط خارجية
  fallback: 0.2   // مصادر غير معروفة
}
```

قابل للتوسع للسحب من Firestore أو قواعد بيانات السمعة الخارجية.

### 4. تحسين القياس عن بُعد (Telemetry)

**محدّث**: `src/lib/types/telemetry.ts`

تمت إضافة نوع حدث جديد: `rag.validate`

```typescript
export type RagValidate = EventBase & {
  type: "rag.validate";
  score: number;
  subscores: {
    citation: number;
    context: number;
    source: number;
    relevance: number;
  };
};
```

يسجل درجات التحقق في مجموعة `ops_events` للتحليلات.

## البنية المعمارية

### تدفق التحقق

```
طلب المستخدم
    ↓
وكيل المخطط (تفكيك الهدف)
    ↓
وكيل الباحث (استرجاع المستندات)
    ↓
وكيل المُركّب (دمج الحقائق)
    ↓
وكيل الناقد (التحقق الأولي)
    ↓
وكيل المُحقق (تسجيل الجودة) ← جديد
    ↓
    ├─ الدرجة ≥ 0.55 → FINAL ✅
    └─ الدرجة < 0.55 → CRITIQUE (العودة إلى الباحث) ❌
```

### عملية التسجيل

```typescript
const score = scoreValidation({
  text: "محتوى الإجابة...",
  query: "السؤال الأصلي",
  citations: [
    { docId: "1", score: 0.9 },
    { docId: "2", score: 0.8 }
  ],
  contextHints: ["React", "hooks"]
});

// النتيجة:
{
  final: 0.72,
  subscores: {
    citation: 0.33,  // 2 استشهادات / 6 = 0.33
    context: 1.0,    // جميع التلميحات متطابقة
    source: 0.5,     // متوسط سمعة المصدر
    relevance: 0.8   // تداخل جيد في المصطلحات
  }
}
```

## التكامل مع API

### نقطة النهاية المحدثة: `/api/mesh/execute`

**التغييرات**:
1. تمت إضافة `ValidatorAgent` إلى مجموعة الوكلاء
2. زيادة `maxHops` من 6 إلى 7 لاستيعاب خطوة التحقق
3. يعمل المحقق بعد الناقد، قبل الموافقة النهائية

**مثال طلب**:
```bash
curl -X POST http://localhost:3030/api/mesh/execute \
  -H "Authorization: Bearer YOUR_FIREBASE_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "goal": "اشرح كيف يعمل الجدول الزمني للذاكرة",
    "hints": ["React", "hooks"],
    "strategy": "critic"
  }'
```

## الاختبارات

### ملفات الاختبار المُنشأة

1. **`__tests__/scoring.spec.ts`**
   - اختبارات حسابات محرك التسجيل
   - التحقق من جميع النقاط الفرعية الأربعة
   - اختبار منطق العتبة
   - اختبار توليد الملاحظات

2. **`__tests__/validator.spec.ts`**
   - اختبارات سلوك ValidatorAgent
   - اختبار قرارات CRITIQUE مقابل FINAL
   - اختبار الحفاظ على الأدلة
   - اختبار تكامل تلميحات السياق

### تشغيل الاختبارات

```bash
# تشغيل جميع اختبارات المرحلة 61
pnpm test __tests__/scoring.spec.ts
pnpm test __tests__/validator.spec.ts

# التشغيل مع التغطية
pnpm test --coverage __tests__/scoring.spec.ts __tests__/validator.spec.ts
```

## الملفات المُنشأة/المُعدَّلة

### ملفات جديدة (6)

1. ✅ `src/orchestrator/rag/sourceReputation.ts` - نظام سمعة المصدر
2. ✅ `src/orchestrator/rag/scoring.ts` - محرك التسجيل مع 4 أبعاد
3. ✅ `src/orchestrator/agents/roles/validatorAgent.ts` - وكيل المحقق
4. ✅ `__tests__/scoring.spec.ts` - اختبارات التسجيل
5. ✅ `__tests__/validator.spec.ts` - اختبارات المحقق
6. ✅ `PHASE_61_AR.md` - هذه الوثائق

### ملفات معدَّلة (2)

1. ✅ `src/lib/types/telemetry.ts` - إضافة نوع حدث `RagValidate`
2. ✅ `src/app/api/mesh/execute/route.ts` - تكامل وكيل المحقق

## أمثلة الاستخدام

### التحقق الأساسي

```typescript
import { scoreValidation } from "@/orchestrator/rag/scoring";

const result = scoreValidation({
  text: "يستخدم الجدول الزمني للذاكرة React hooks لإدارة الحالة",
  query: "كيف يعمل الجدول الزمني للذاكرة؟",
  citations: [
    { docId: "1", score: 0.9 },
    { docId: "2", score: 0.8 }
  ],
  contextHints: ["React", "hooks"]
});

console.log(`الدرجة: ${result.final}`);
console.log(`النقاط الفرعية:`, result.subscores);
```

### استخدام وكيل المحقق

```typescript
import { ValidatorAgent } from "@/orchestrator/agents/roles/validatorAgent";

const validator = new ValidatorAgent();

const message = {
  type: "HYPOTHESIS",
  content: "نص الإجابة...",
  from: "synthesizer",
  evidence: [...]
};

const result = await validator.handle(message, context);

if (result.type === "FINAL") {
  console.log("نجح التحقق!");
} else {
  console.log("يحتاج إلى تحسين:", result.content);
}
```

## الفوائد

### 1. تقليل الهلوسة
- التحقق من دعم الأدلة قبل قبول الإجابات
- يتطلب الحد الأدنى من تغطية الاستشهادات
- التحقق من جودة المصدر

### 2. تحسين جودة الإجابة
- التسجيل متعدد الأبعاد يضمن الجودة الشاملة
- مواءمة السياق تمنع الإجابات خارج الموضوع
- تسجيل الملاءمة يضمن معالجة الاستعلام

### 3. ملاحظات قابلة للتنفيذ
- رسائل CRITIQUE تشرح المشاكل المحددة
- تساعد وكيل الباحث على تحسين جمع الأدلة
- تنشئ حلقة ملاحظات للتحسين المستمر

### 4. التحقق القابل للملاحظة
- القياس عن بُعد يتتبع جميع قرارات التحقق
- النقاط الفرعية تحدد نقاط الضعف المحددة
- يمكّن من اختبار A/B للعتبات

## الخطوات التالية (تحسينات مستقبلية)

### المرحلة 61.1: عتبات ديناميكية
- ضبط العتبة بناءً على تعقيد الاستعلام
- عتبة أعلى للاستعلامات الحرجة
- عتبة أقل للاستعلامات الاستكشافية

### المرحلة 61.2: قاعدة بيانات سمعة المصدر
- نقل درجات السمعة إلى Firestore
- السماح بالتحديثات الديناميكية بناءً على الملاحظات
- تتبع موثوقية المصدر بمرور الوقت

### المرحلة 61.3: التسجيل المعتمد على ML
- استبدال التسجيل القائم على القواعد بنماذج ML
- التدريب على الأمثلة المُتحقق منها
- التعلم المستمر من ملاحظات المستخدم

### المرحلة 61.4: فواصل الثقة
- إضافة درجات الثقة إلى التحقق
- التعبير عن عدم اليقين في الحالات الحدودية
- توفير نطاقات ثقة للنقاط الفرعية

### المرحلة 61.5: لوحة معلومات التحقق
- واجهة مستخدم لعرض مقاييس التحقق
- رسوم بيانية تُظهر توزيعات النقاط
- تنبيهات لحالات فشل التحقق المستمرة

## الحالة

✅ **اليوم الأول من المرحلة 61 مكتمل**

تم تنفيذ جميع المكونات الأساسية:
- ✅ ValidatorAgent مع تسجيل 4 أبعاد
- ✅ نظام سمعة المصدر
- ✅ تكامل القياس عن بُعد
- ✅ تكامل نقطة نهاية API
- ✅ مجموعة اختبار شاملة
- ✅ الوثائق

جاهز لـ:
- الاختبار في بيئة التطوير
- التكامل مع تدفقات الشبكة الموجودة
- مراقبة مقاييس التحقق
- تحسينات ML المستقبلية

## الاعتمادات

تم إكمال تنفيذ المرحلة 61 في 2025-11-07.

**البنية المعمارية**: طبقة التحقق المعرفي مع التسجيل متعدد الأبعاد
**أبعاد التسجيل**: الاستشهاد، السياق، المصدر، الملاءمة
**عتبة التحقق**: 0.55 (قابلة للتكوين)
**التكامل**: إضافة سلسة إلى موجه الشبكة الحالي
